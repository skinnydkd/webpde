<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üèÜ Concurs PDE - Economia, Finances i Empresa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Plus Jakarta Sans', -apple-system, sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-10px); } 40% { transform: translateX(10px); } 60% { transform: translateX(-10px); } 80% { transform: translateX(10px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px #fbbf24; } 50% { box-shadow: 0 0 20px #fbbf24, 0 0 30px #f59e0b; } }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes correctPulse { 0% { background-color: rgba(74, 222, 128, 0.3); } 50% { background-color: rgba(74, 222, 128, 0.6); } 100% { background-color: rgba(74, 222, 128, 0.3); } }
        @keyframes wrongShake { 0%, 100% { transform: translateX(0); background-color: rgba(248, 113, 113, 0.3); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        .animate-pulse-custom { animation: pulse 0.5s ease-in-out; }
        .animate-shake { animation: shake 0.5s ease-in-out; }
        .animate-bounce { animation: bounce 0.5s ease-in-out; }
        .animate-glow { animation: glow 1s ease-in-out infinite; }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .animate-popIn { animation: popIn 0.3s ease-out; }
        .animate-correct { animation: correctPulse 0.5s ease-in-out; }
        .animate-wrong { animation: wrongShake 0.5s ease-in-out; }
        .gold-gradient { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .confetti { position: fixed; width: 10px; height: 10px; top: -10px; animation: confetti 3s linear forwards; pointer-events: none; z-index: 1000; }
        .streak-fire { text-shadow: 0 0 10px #f97316, 0 0 20px #ea580c, 0 0 30px #dc2626; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        /* IMPORTANT: Evitar problemes amb el teclat en m√≤bil */
        html { height: -webkit-fill-available; }
        body { 
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
        }
        input, textarea, select { font-size: 16px !important; } /* Evita zoom autom√†tic en iOS */
        input:focus { outline: none; }
        
        /* Input flotant fix per m√≤bil */
        #numeric-input-container {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(30, 27, 75, 0.98), rgba(30, 27, 75, 0.95));
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            z-index: 9999;
            border-top: 2px solid rgba(250, 204, 21, 0.5);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }
        #numeric-input-container.active { display: block; }
        #numeric-input-field {
            width: 100%;
            padding: 16px;
            font-size: 24px !important;
            font-weight: bold;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: white;
            margin-bottom: 12px;
        }
        #numeric-input-field:focus {
            border-color: #facc15;
            background: rgba(255,255,255,0.15);
        }
        #numeric-input-field::placeholder { color: rgba(255,255,255,0.5); }
        #numeric-submit-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
        }
        #numeric-submit-btn:active { transform: scale(0.98); }
        #numeric-submit-btn:disabled { opacity: 0.5; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 min-h-screen">
    <!-- INPUT NUM√àRIC FORA DE REACT - NO ES RE-RENDERITZA MAI! -->
    <div id="numeric-input-container">
        <input 
            type="text" 
            id="numeric-input-field" 
            inputmode="decimal" 
            pattern="[0-9.,\-]*"
            placeholder="Resultat num√®ric..."
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
        />
        <button id="numeric-submit-btn" type="button">COMPROVAR</button>
    </div>
    
    <!-- SCRIPT PER L'INPUT FLOTANT - COMPLETAMENT FORA DE REACT! -->
    <script>
    (function() {
        const container = document.getElementById('numeric-input-container');
        const input = document.getElementById('numeric-input-field');
        const btn = document.getElementById('numeric-submit-btn');
        let isVisible = false;
        
        function handleSubmit() {
            const value = input.value.trim();
            if (value && window.submitNumericAnswer) {
                window.submitNumericAnswer(value);
            }
        }
        
        btn.addEventListener('click', handleSubmit);
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSubmit();
            }
        });
        
        // Prevenir que React pugui fer res estrany
        input.addEventListener('input', function(e) {
            e.stopPropagation();
        });
        
        // API global per controlar l'input des de React
        window.numericInputAPI = {
            show: function(placeholder, lang) {
                // IMPORTANT: Nom√©s netejar si NO estava visible (nova pregunta)
                if (!isVisible) {
                    input.value = '';
                    isVisible = true;
                }
                input.placeholder = placeholder || 'Resultat num√®ric...';
                btn.textContent = lang === 'val' ? 'COMPROVAR' : lang === 'es' ? 'COMPROBAR' : 'CHECK';
                container.classList.add('active');
                // Focus nom√©s si no t√© focus
                if (document.activeElement !== input) {
                    setTimeout(function() { input.focus(); }, 150);
                }
            },
            hide: function() {
                container.classList.remove('active');
                isVisible = false;
                // No fer blur si l'usuari est√† escrivint
            },
            clear: function() {
                input.value = '';
            },
            reset: function() {
                input.value = '';
                isVisible = false;
            }
        };
    })();
    </script>
    
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useMemo, useRef, useCallback, memo } = React;

// TIMER AMB DOM DIRECTE - NO CAUSA CAP RE-RENDER DEL PARE!
function TimerDirect({ timerKey, onTimeUp, isActive }) {
    const timeRef = useRef(60);
    const intervalRef = useRef(null);
    const barRef = useRef(null);
    const textRef = useRef(null);
    const onTimeUpRef = useRef(onTimeUp);
    
    // Actualitzar la refer√®ncia del callback sense causar re-render
    useEffect(() => {
        onTimeUpRef.current = onTimeUp;
    }, [onTimeUp]);
    
    // Reset quan canvia timerKey (nova pregunta)
    useEffect(() => {
        timeRef.current = 60;
        if (textRef.current) {
            textRef.current.textContent = '60s';
            textRef.current.className = 'text-2xl font-black min-w-[50px] text-right text-white';
        }
        if (barRef.current) {
            barRef.current.style.width = '100%';
            barRef.current.className = 'h-full bg-green-500 transition-all duration-1000';
        }
    }, [timerKey]);
    
    // Gestionar interval - actualitza DOM directament
    useEffect(() => {
        if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }
        
        if (!isActive) return;
        
        intervalRef.current = setInterval(() => {
            timeRef.current -= 1;
            const t = timeRef.current;
            
            // ACTUALITZAR DOM DIRECTAMENT - SENSE setState!
            if (textRef.current) {
                textRef.current.textContent = t + 's';
                textRef.current.className = t > 30 
                    ? 'text-2xl font-black min-w-[50px] text-right text-white'
                    : t > 10 
                        ? 'text-2xl font-black min-w-[50px] text-right text-amber-400'
                        : 'text-2xl font-black min-w-[50px] text-right text-red-400 animate-pulse';
            }
            if (barRef.current) {
                barRef.current.style.width = ((t / 60) * 100) + '%';
                barRef.current.className = t > 30 
                    ? 'h-full bg-green-500 transition-all duration-1000'
                    : t > 10 
                        ? 'h-full bg-amber-500 transition-all duration-1000'
                        : 'h-full bg-red-500 transition-all duration-1000';
            }
            
            if (t <= 0) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
                if (onTimeUpRef.current) onTimeUpRef.current();
            }
        }, 1000);
        
        return () => {
            if (intervalRef.current) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
            }
        };
    }, [isActive, timerKey]);
    
    // Exposar funci√≥ per afegir temps (per l'ajuda +60s)
    useEffect(() => {
        window.addTimerTime = (seconds) => {
            timeRef.current = Math.min(timeRef.current + seconds, 120);
            if (textRef.current) textRef.current.textContent = timeRef.current + 's';
            if (barRef.current) barRef.current.style.width = Math.min((timeRef.current / 60) * 100, 100) + '%';
        };
        return () => { delete window.addTimerTime; };
    }, []);
    
    return (
        <div className="flex items-center gap-3">
            <div className="flex-1 h-2 bg-white/20 rounded-full overflow-hidden">
                <div ref={barRef} className="h-full bg-green-500 transition-all duration-1000" style={{width: '100%'}}></div>
            </div>
            <span ref={textRef} className="text-2xl font-black min-w-[50px] text-right text-white">60s</span>
        </div>
    );
}

// Efecte confetti
const Confetti = ({ show }) => {
    if (!show) return null;
    const colors = ['#f59e0b', '#10b981', '#3b82f6', '#ec4899', '#8b5cf6', '#ef4444'];
    return (
        <>
            {[...Array(50)].map((_, i) => (
                <div key={i} className="confetti" style={{
                    left: `${Math.random() * 100}%`,
                    backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                    animationDelay: `${Math.random() * 2}s`,
                    borderRadius: Math.random() > 0.5 ? '50%' : '0',
                }}></div>
            ))}
        </>
    );
};

// Toast notifications
const Toast = ({ message, type, show }) => {
    if (!show) return null;
    const bg = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    return (
        <div className={`fixed top-4 right-4 ${bg} text-white px-6 py-3 rounded-xl font-bold shadow-lg animate-slideIn z-50`}>
            {message}
        </div>
    );
};

// Component per mostrar punts guanyats/perduts
const PointsPopup = ({ points, show }) => {
    if (!show) return null;
    const isPositive = points > 0;
    return (
        <div className={`fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-black animate-popIn z-50 ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
            {isPositive ? '+' : ''}{points}
        </div>
    );
};

function ConcursApp() {
    const [idioma, setIdioma] = useState('val');
    const [fase, setFase] = useState('inici');
    const [categoria, setCategoria] = useState('totes');
    const [nomJugador, setNomJugador] = useState('');
    const [preguntaActual, setPreguntaActual] = useState(0);
    const [puntuacio, setPuntuacio] = useState(0);
    const [respostes, setRespostes] = useState([]);
    const [ratxa, setRatxa] = useState(0);
    const [maxRatxa, setMaxRatxa] = useState(0);
    const [preguntesPartida, setPreguntesPartida] = useState([]);
    const [respostaUsuari, setRespostaUsuari] = useState(null);
    const [mostrarResultat, setMostrarResultat] = useState(false);
    const [ranking, setRanking] = useState([]);
    const [ordreUsuari, setOrdreUsuari] = useState([]);
    const [timerKey, setTimerKey] = useState(0);
    const [timerActive, setTimerActive] = useState(false);
    const [showConfetti, setShowConfetti] = useState(false);
    const [toast, setToast] = useState({ show: false, message: '', type: '' });
    const [pointsPopup, setPointsPopup] = useState({ show: false, points: 0 });
    const [ajudes, setAjudes] = useState({ cinquanta: 1, temps: 1, saltar: 1 });
    const [opcionsEliminades, setOpcionsEliminades] = useState([]);
    const [soundEnabled, setSoundEnabled] = useState(true);
    // Nous estats per tipus interactius
    const [clickedPoint, setClickedPoint] = useState(null);
    const [allocations, setAllocations] = useState([]);
    const [sliderValue, setSliderValue] = useState(25);
    const [selectedOptions, setSelectedOptions] = useState([]);
    
    const t = (val, es, en) => idioma === 'val' ? val : idioma === 'es' ? es : en;
    
    // Efectes de so
    const playSound = useCallback((type) => {
        if (!soundEnabled) return;
        try {
            const sounds = {
                correct: [523.25, 659.25, 783.99], // Do-Mi-Sol
                wrong: [311.13, 293.66], // Mi‚ô≠-Re
                tick: [800],
                bonus: [523.25, 659.25, 783.99, 1046.50], // Do-Mi-Sol-Do'
            };
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const notes = sounds[type] || [440];
            notes.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.1 + 0.3);
                osc.start(ctx.currentTime + i * 0.1);
                osc.stop(ctx.currentTime + i * 0.1 + 0.3);
            });
        } catch(e) {}
    }, [soundEnabled]);
    
    // Vibrar en m√≤bil
    const vibrate = useCallback((pattern) => {
        if (navigator.vibrate) navigator.vibrate(pattern);
    }, []);
    
    // Toast helper
    const showToast = useCallback((message, type = 'info') => {
        setToast({ show: true, message, type });
        setTimeout(() => setToast({ show: false, message: '', type: '' }), 2000);
    }, []);
    
    // GESTI√ì INPUT HTML FLOTANT - Usar l'API global
    const prevPreguntaRef = useRef(-1);
    useEffect(() => {
        const p = preguntesPartida[preguntaActual];
        const esNumeric = p && p.tipus === 'numeric';
        const mostrar = fase === 'jugant' && esNumeric && !mostrarResultat;
        
        if (window.numericInputAPI) {
            // Si hem canviat de pregunta, resetejar l'input
            if (preguntaActual !== prevPreguntaRef.current) {
                window.numericInputAPI.reset();
                prevPreguntaRef.current = preguntaActual;
            }
            
            if (mostrar) {
                const placeholder = idioma === 'val' ? 'Resultat num√®ric...' : idioma === 'es' ? 'Resultado num√©rico...' : 'Numeric result...';
                window.numericInputAPI.show(placeholder, idioma);
            } else {
                window.numericInputAPI.hide();
            }
        }
    }, [fase, preguntaActual, mostrarResultat, preguntesPartida, idioma]);

    // BANC DE PREGUNTES
    const bancPreguntes = useMemo(() => ({
        economia: [
            { id: 'ec1', tipus: 'numeric', dificultat: 'facil', pregunta: t("Elasticitat: Preu puja 10‚Üí12‚Ç¨, Demanda baixa 100‚Üí80u. Elasticitat? (absolut)", "Elasticidad: Precio sube 10‚Üí12‚Ç¨, Demanda baja 100‚Üí80u. ¬øElasticidad? (absoluto)", "Elasticity: Price rises 10‚Üí12‚Ç¨, Demand drops 100‚Üí80u. Elasticity? (absolute)"), correcta: 1, tolerancia: 0.1, pista: "Ed = (%ŒîQ) / (%ŒîP)" },
            { id: 'ec2', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("PIB = C+I+G+(X-M). C=500, I=200, G=150, X=100, M=80. PIB?", "PIB = C+I+G+(X-M). C=500, I=200, G=150, X=100, M=80. ¬øPIB?", "GDP = C+I+G+(X-M). C=500, I=200, G=150, X=100, M=80. GDP?"), correcta: 870, tolerancia: 0, pista: "Suma tots els components" },
            { id: 'ec3', tipus: 'numeric', dificultat: 'facil', pregunta: t("Taxa d'atur: 2M aturats, 18M ocupats. Taxa en %?", "Tasa de paro: 2M parados, 18M ocupados. ¬øTasa en %?", "Unemployment: 2M unemployed, 18M employed. Rate %?"), correcta: 10, tolerancia: 0, pista: "Atur/(Atur+Ocupats)√ó100" },
            { id: 'ec4', tipus: 'numeric', dificultat: 'dificil', pregunta: t("Multiplicador keynesi√† amb PMC=0.8?", "Multiplicador keynesiano con PMC=0.8?", "Keynesian multiplier with MPC=0.8?"), correcta: 5, tolerancia: 0, pista: "1/(1-PMC)" },
            { id: 'ec5', tipus: 'numeric', dificultat: 'facil', pregunta: t("Inflaci√≥: IPC anterior=100, IPC actual=103. Inflaci√≥ %?", "Inflaci√≥n: IPC anterior=100, IPC actual=103. ¬øInflaci√≥n %?", "Inflation: Previous CPI=100, Current CPI=103. Inflation %?"), correcta: 3, tolerancia: 0, pista: "(IPCnew-IPCold)/IPCold√ó100" },
            { id: 'ec6', tipus: 'numeric', dificultat: 'dificil', pregunta: t("Creixement real: PIB nominal +7%, inflaci√≥ 4%. Creixement real aprox?", "Crecimiento real: PIB nominal +7%, inflaci√≥n 4%. ¬øCrecimiento real aprox?", "Real growth: Nominal GDP +7%, inflation 4%. Approx real growth?"), correcta: 3, tolerancia: 0.5, pista: "Nominal - Inflaci√≥" },
            { id: 'ec7', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("Balan√ßa comercial: X=50.000M‚Ç¨, M=65.000M‚Ç¨. Saldo?", "Balanza comercial: X=50.000M‚Ç¨, M=65.000M‚Ç¨. ¬øSaldo?", "Trade balance: X=‚Ç¨50,000M, M=‚Ç¨65,000M. Balance?"), correcta: -15000, tolerancia: 0, pista: "X - M" },
            { id: 'eo1', tipus: 'order', dificultat: 'mitjana', pregunta: t("Fases del cicle econ√≤mic:", "Fases del ciclo econ√≥mico:", "Business cycle phases:"), elements: [t("Expansi√≥", "Expansi√≥n", "Expansion"), t("Cim", "Cima", "Peak"), t("Recessi√≥", "Recesi√≥n", "Recession"), t("Fons", "Valle", "Trough")], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'eo2', tipus: 'order', dificultat: 'dificil', pregunta: t("Escoles econ√≤miques cronol√≤gicament:", "Escuelas econ√≥micas cronol√≥gicamente:", "Economic schools chronologically:"), elements: [t("Mercantilisme", "Mercantilismo", "Mercantilism"), t("Fisiocr√†cia", "Fisiocracia", "Physiocracy"), t("Cl√†ssica", "Cl√°sica", "Classical"), t("Keynesiana", "Keynesiana", "Keynesian")], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'eo3', tipus: 'order', dificultat: 'facil', pregunta: t("Sectors econ√≤mics (ordre cl√†ssic):", "Sectores econ√≥micos (orden cl√°sico):", "Economic sectors (classic order):"), elements: [t("Primari", "Primario", "Primary"), t("Secundari", "Secundario", "Secondary"), t("Terciari", "Terciario", "Tertiary")], ordreCorrecte: [0, 1, 2] },
            { id: 'ef1', tipus: 'formula', dificultat: 'facil', pregunta: "PIB = C + I + G + ___", opcions: ["(X-M)", "(M-X)", "T", "S"], correcta: 0 },
            { id: 'ef2', tipus: 'formula', dificultat: 'mitjana', pregunta: t("Taxa d'atur = Aturats / ___ √ó 100", "Tasa de paro = Parados / ___ √ó 100", "Unemployment = Unemployed / ___ √ó 100"), opcions: [t("Poblaci√≥ activa", "Poblaci√≥n activa", "Labor force"), t("Poblaci√≥ total", "Poblaci√≥n total", "Total pop."), t("Ocupats", "Ocupados", "Employed"), "PIB"], correcta: 0 },
            { id: 'ef3', tipus: 'formula', dificultat: 'dificil', pregunta: t("Multiplicador = 1 / (1 - ___)", "Multiplicador = 1 / (1 - ___)", "Multiplier = 1 / (1 - ___)"), opcions: ["PMC", "PMA", "i", "t"], correcta: 0 },
            { id: 'eg1', tipus: 'identify', dificultat: 'facil', pregunta: t("Identifica el gr√†fic d'equilibri de mercat:", "Identifica el gr√°fico de equilibrio de mercado:", "Identify market equilibrium graph:"), imatge: "oferta_demanda", opcions: ["Phillips", t("Oferta-Demanda", "Oferta-Demanda", "Supply-Demand"), "IS-LM", "Laffer"], correcta: 1 },
            { id: 'eg2', tipus: 'identify', dificultat: 'mitjana', pregunta: t("Quin model macroecon√≤mic √©s aquest?", "¬øQu√© modelo macroecon√≥mico es este?", "Which macro model is this?"), imatge: "islm", opcions: ["AD-AS", "IS-LM", t("Flux circular", "Flujo circular", "Circular flow"), "Phillips"], correcta: 1 },
            { id: 'eg3', tipus: 'identify', dificultat: 'dificil', pregunta: t("Corba que relaciona impostos i recaptaci√≥:", "Curva que relaciona impuestos y recaudaci√≥n:", "Curve relating taxes and revenue:"), imatge: "laffer", opcions: ["Phillips", "Lorenz", "Laffer", "Engel"], correcta: 2 },
            { id: 'ev1', tipus: 'truefalse', dificultat: 'facil', pregunta: t("La inflaci√≥ √©s la pujada generalitzada i sostinguda dels preus", "La inflaci√≥n es la subida generalizada y sostenida de los precios", "Inflation is the general sustained rise in prices"), correcta: true },
            { id: 'ev2', tipus: 'truefalse', dificultat: 'mitjana', pregunta: t("La corba de Phillips mostra relaci√≥ DIRECTA inflaci√≥-atur", "La curva de Phillips muestra relaci√≥n DIRECTA inflaci√≥n-paro", "Phillips curve shows DIRECT inflation-unemployment relation"), correcta: false },
        ],
        finances: [
            // TIPUS INTERACTIU: click_chart - Clica on comprar/vendre
            { id: 'fi1', tipus: 'click_chart', dificultat: 'facil', 
              pregunta: t("üìà Clica on COMPRAR (punt m√©s baix)", "üìà Haz clic donde COMPRAR (punto m√°s bajo)", "üìà Click where to BUY (lowest point)"),
              chartData: [100, 95, 88, 82, 78, 75, 80, 85, 92, 98, 105, 110],
              correctZone: { min: 4, max: 6 }, // √≠ndexs correctes
              pista: t("Compra baix, ven alt!", "¬°Compra bajo, vende alto!", "Buy low, sell high!") },
            { id: 'fi2', tipus: 'click_chart', dificultat: 'facil',
              pregunta: t("üìâ Clica on VENDRE (punt m√©s alt)", "üìâ Haz clic donde VENDER (punto m√°s alto)", "üìâ Click where to SELL (highest point)"),
              chartData: [50, 55, 62, 70, 78, 85, 82, 75, 68, 60, 55, 52],
              correctZone: { min: 4, max: 6 },
              pista: t("Busca el m√†xim!", "¬°Busca el m√°ximo!", "Find the peak!") },
            { id: 'fi3', tipus: 'click_chart', dificultat: 'mitjana',
              pregunta: t("üéØ Identifica el SUPORT (on el preu rebota)", "üéØ Identifica el SOPORTE (donde el precio rebota)", "üéØ Identify SUPPORT (where price bounces)"),
              chartData: [100, 92, 85, 80, 82, 88, 84, 80, 83, 90, 86, 80, 85],
              correctZone: { min: 2, max: 4 },
              pista: t("El suport √©s un nivell on el preu no baixa m√©s", "El soporte es un nivel donde el precio no baja m√°s", "Support is a level where price doesn't fall further") },
              
            // TIPUS INTERACTIU: allocate - Distribueix la cartera
            { id: 'fa1', tipus: 'allocate', dificultat: 'mitjana',
              pregunta: t("üíº Perfil CONSERVADOR (60 anys, jubilaci√≥ propera). Distribueix la cartera:", "üíº Perfil CONSERVADOR (60 a√±os, jubilaci√≥n cercana). Distribuye la cartera:", "üíº CONSERVATIVE profile (60yo, near retirement). Allocate portfolio:"),
              assets: [
                { nom: t("Renda Fixa", "Renta Fija", "Bonds"), icon: "üè¶", color: "blue" },
                { nom: t("Accions", "Acciones", "Stocks"), icon: "üìà", color: "green" },
                { nom: t("Liquiditat", "Liquidez", "Cash"), icon: "üíµ", color: "amber" }
              ],
              correctRanges: { 0: [50, 70], 1: [15, 35], 2: [10, 25] },
              pista: t("Conservador = m√©s renda fixa, menys risc", "Conservador = m√°s renta fija, menos riesgo", "Conservative = more bonds, less risk") },
            { id: 'fa2', tipus: 'allocate', dificultat: 'facil',
              pregunta: t("üíº Perfil AGRESSIU (25 anys, horitz√≥ llarg). Distribueix la cartera:", "üíº Perfil AGRESIVO (25 a√±os, horizonte largo). Distribuye la cartera:", "üíº AGGRESSIVE profile (25yo, long horizon). Allocate portfolio:"),
              assets: [
                { nom: t("Renda Fixa", "Renta Fija", "Bonds"), icon: "üè¶", color: "blue" },
                { nom: t("Accions", "Acciones", "Stocks"), icon: "üìà", color: "green" },
                { nom: t("Liquiditat", "Liquidez", "Cash"), icon: "üíµ", color: "amber" }
              ],
              correctRanges: { 0: [5, 25], 1: [60, 85], 2: [5, 20] },
              pista: t("Jove = m√©s temps per recuperar p√®rdues", "Joven = m√°s tiempo para recuperar p√©rdidas", "Young = more time to recover losses") },
              
            // TIPUS INTERACTIU: scenario - Escenaris de decisi√≥
            { id: 'fs1', tipus: 'scenario', dificultat: 'mitjana',
              pregunta: t("üè† Tens 30.000‚Ç¨ estalviats. Vols comprar pis (entrada 40.000‚Ç¨). Qu√® fas?", "üè† Tienes 30.000‚Ç¨ ahorrados. Quieres comprar piso (entrada 40.000‚Ç¨). ¬øQu√© haces?", "üè† You have ‚Ç¨30,000 saved. Want to buy flat (down payment ‚Ç¨40,000). What do you do?"),
              opcions: [
                { text: t("Esperar i estalviar m√©s", "Esperar y ahorrar m√°s", "Wait and save more"), icon: "‚è≥", correcta: true },
                { text: t("Demanar pr√©stec personal per la difer√®ncia", "Pedir pr√©stamo personal por la diferencia", "Get personal loan for difference"), icon: "üí≥", correcta: false },
                { text: t("Invertir els 30.000‚Ç¨ en cripto per duplicar-los", "Invertir los 30.000‚Ç¨ en cripto para duplicarlos", "Invest ‚Ç¨30,000 in crypto to double it"), icon: "üé∞", correcta: false },
                { text: t("Comprar pis m√©s barat amb menys entrada", "Comprar piso m√°s barato con menos entrada", "Buy cheaper flat with less down payment"), icon: "üèòÔ∏è", correcta: true }
              ],
              multipleCorrect: true,
              pista: t("Evita endeutar-te amb pr√©stecs cars!", "¬°Evita endeudarte con pr√©stamos caros!", "Avoid expensive debt!") },
            { id: 'fs2', tipus: 'scenario', dificultat: 'facil',
              pregunta: t("üí∏ Reps 5.000‚Ç¨ inesperats. Tens deute de targeta al 20% TAE. Qu√® fas PRIMER?", "üí∏ Recibes 5.000‚Ç¨ inesperados. Tienes deuda de tarjeta al 20% TAE. ¬øQu√© haces PRIMERO?", "üí∏ You receive unexpected ‚Ç¨5,000. Have credit card debt at 20% APR. What do you do FIRST?"),
              opcions: [
                { text: t("Pagar el deute de la targeta", "Pagar la deuda de la tarjeta", "Pay off credit card debt"), icon: "üí≥", correcta: true },
                { text: t("Invertir en borsa", "Invertir en bolsa", "Invest in stocks"), icon: "üìà", correcta: false },
                { text: t("Anar de vacances", "Ir de vacaciones", "Go on vacation"), icon: "‚úàÔ∏è", correcta: false },
                { text: t("Guardar-ho tot al banc", "Guardarlo todo en el banco", "Keep it all in bank"), icon: "üè¶", correcta: false }
              ],
              pista: t("El 20% √©s molt dif√≠cil de superar invertint!", "¬°El 20% es muy dif√≠cil de superar invirtiendo!", "20% is very hard to beat by investing!") },
            { id: 'fs3', tipus: 'scenario', dificultat: 'dificil',
              pregunta: t("üìä Mercat cau 30%. La teua cartera tamb√©. Qu√® fas?", "üìä El mercado cae 30%. Tu cartera tambi√©n. ¬øQu√© haces?", "üìä Market drops 30%. Your portfolio too. What do you do?"),
              opcions: [
                { text: t("Vendre tot per evitar m√©s p√®rdues", "Vender todo para evitar m√°s p√©rdidas", "Sell everything to avoid more losses"), icon: "üèÉ", correcta: false },
                { text: t("Mantenir i esperar la recuperaci√≥", "Mantener y esperar la recuperaci√≥n", "Hold and wait for recovery"), icon: "üßò", correcta: true },
                { text: t("Comprar m√©s aprofitant els preus baixos", "Comprar m√°s aprovechando los precios bajos", "Buy more taking advantage of low prices"), icon: "üõí", correcta: true },
                { text: t("Moure-ho tot a cripto", "Moverlo todo a cripto", "Move everything to crypto"), icon: "ü™ô", correcta: false }
              ],
              multipleCorrect: true,
              pista: t("Vendre en p√†nic cristal¬∑litza les p√®rdues!", "¬°Vender en p√°nico cristaliza las p√©rdidas!", "Panic selling locks in losses!") },
              
            // TIPUS: slider_value - Ajusta per trobar el valor correcte
            { id: 'fsl1', tipus: 'slider_value', dificultat: 'facil',
              pregunta: t("üéöÔ∏è Regla del 50/30/20: Quin % del sou hauries de destinar a ESTALVI?", "üéöÔ∏è Regla del 50/30/20: ¬øQu√© % del sueldo deber√≠as destinar a AHORRO?", "üéöÔ∏è 50/30/20 Rule: What % of salary should go to SAVINGS?"),
              min: 0, max: 50, correcta: 20, tolerancia: 2,
              labels: { left: "0%", right: "50%" },
              pista: "50% necessitats, 30% desitjos, 20% estalvi" },
            { id: 'fsl2', tipus: 'slider_value', dificultat: 'mitjana',
              pregunta: t("üéöÔ∏è Fons d'emerg√®ncia: Quants MESOS de despeses hauries de tenir?", "üéöÔ∏è Fondo de emergencia: ¬øCu√°ntos MESES de gastos deber√≠as tener?", "üéöÔ∏è Emergency fund: How many MONTHS of expenses should you have?"),
              min: 1, max: 12, correcta: 6, tolerancia: 1,
              labels: { left: "1 mes", right: "12 mesos" },
              pista: t("Entre 3 i 6 mesos √©s l'est√†ndard", "Entre 3 y 6 meses es el est√°ndar", "3-6 months is standard") },
              
            // TIPUS: match_risk - Relaciona producte amb nivell de risc
            { id: 'fm1', tipus: 'match_risk', dificultat: 'mitjana',
              pregunta: t("üéØ Ordena de MENYS a M√âS risc:", "üéØ Ordena de MENOS a M√ÅS riesgo:", "üéØ Order from LESS to MORE risk:"),
              elements: [
                { nom: t("Dip√≤sit bancari", "Dep√≥sito bancario", "Bank deposit"), icon: "üè¶" },
                { nom: t("Bons govern", "Bonos gobierno", "Gov bonds"), icon: "üìú" },
                { nom: t("Fons indexat", "Fondo indexado", "Index fund"), icon: "üìä" },
                { nom: t("Accions individuals", "Acciones individuales", "Individual stocks"), icon: "üìà" },
                { nom: t("Criptomonedes", "Criptomonedas", "Crypto"), icon: "ü™ô" }
              ],
              ordreCorrecte: [0, 1, 2, 3, 4] },
              
            // Preguntes m√©s tradicionals per√≤ amb context pr√†ctic
            { id: 'ft1', tipus: 'truefalse', dificultat: 'facil', 
              pregunta: t("üí° Si inverteixes 10.000‚Ç¨ al 7% anual, en 10 anys tindr√†s aproximadament 20.000‚Ç¨ (regla del 72)", "üí° Si inviertes 10.000‚Ç¨ al 7% anual, en 10 a√±os tendr√°s aproximadamente 20.000‚Ç¨ (regla del 72)", "üí° If you invest ‚Ç¨10,000 at 7% annually, in 10 years you'll have approximately ‚Ç¨20,000 (rule of 72)"), 
              correcta: true },
            { id: 'ft2', tipus: 'truefalse', dificultat: 'mitjana', 
              pregunta: t("üí° Un ETF √©s m√©s arriscat que una acci√≥ individual perqu√® t√© m√©s volatilitat", "üí° Un ETF es m√°s arriesgado que una acci√≥n individual porque tiene m√°s volatilidad", "üí° An ETF is riskier than an individual stock because it has more volatility"), 
              correcta: false },
            { id: 'ft3', tipus: 'truefalse', dificultat: 'facil', 
              pregunta: t("üí° Si la inflaci√≥ √©s del 3% i el teu compte et dona 1%, est√†s perdent poder adquisitiu", "üí° Si la inflaci√≥n es del 3% y tu cuenta te da 1%, est√°s perdiendo poder adquisitivo", "üí° If inflation is 3% and your account gives 1%, you're losing purchasing power"), 
              correcta: true },
            { id: 'fn1', tipus: 'numeric', dificultat: 'facil', 
              pregunta: t("üßÆ Regla del 72: A quin % anual es duplica el capital en 12 anys?", "üßÆ Regla del 72: ¬øA qu√© % anual se duplica el capital en 12 a√±os?", "üßÆ Rule of 72: At what annual % does capital double in 12 years?"), 
              correcta: 6, tolerancia: 0, pista: "72 / anys = inter√®s" },
            { id: 'fn2', tipus: 'numeric', dificultat: 'mitjana', 
              pregunta: t("üßÆ Estalvies 200‚Ç¨/mes durant 5 anys sense interessos. Total?", "üßÆ Ahorras 200‚Ç¨/mes durante 5 a√±os sin intereses. ¬øTotal?", "üßÆ Save ‚Ç¨200/month for 5 years with no interest. Total?"), 
              correcta: 12000, tolerancia: 0, pista: "200 √ó 12 √ó 5" },
        ],
        empresa: [
            { id: 'emc1', tipus: 'numeric', dificultat: 'facil', pregunta: t("Punt Mort: CF=15.000‚Ç¨, P=60‚Ç¨, CVu=30‚Ç¨. Unitats?", "Punto Muerto: CF=15.000‚Ç¨, P=60‚Ç¨, CVu=30‚Ç¨. ¬øUnidades?", "Break-even: FC=‚Ç¨15,000, P=‚Ç¨60, VCu=‚Ç¨30. Units?"), correcta: 500, tolerancia: 0, pista: "CF/(P-CVu)" },
            { id: 'emc2', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("Cost Total: CF=8.000‚Ç¨, CVu=15‚Ç¨, Q=400. CT?", "Coste Total: CF=8.000‚Ç¨, CVu=15‚Ç¨, Q=400. ¬øCT?", "Total Cost: FC=‚Ç¨8,000, VCu=‚Ç¨15, Q=400. TC?"), correcta: 14000, tolerancia: 0, pista: "CF + CVu√óQ" },
            { id: 'emc3', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("Productivitat: 10.000u, 25 treballadors. Prod/treballador?", "Productividad: 10.000u, 25 trabajadores. ¬øProd/trabajador?", "Productivity: 10,000u, 25 workers. Prod/worker?"), correcta: 400, tolerancia: 0, pista: "Producci√≥/Treballadors" },
            { id: 'emc4', tipus: 'numeric', dificultat: 'facil', pregunta: t("Marge contribuci√≥: P=100‚Ç¨, CVu=60‚Ç¨. MCu?", "Margen contribuci√≥n: P=100‚Ç¨, CVu=60‚Ç¨. ¬øMCu?", "Contribution margin: P=‚Ç¨100, VCu=‚Ç¨60. UCM?"), correcta: 40, tolerancia: 0, pista: "P - CVu" },
            { id: 'emc5', tipus: 'numeric', dificultat: 'dificil', pregunta: t("EOQ: D=10.000u/any, Cp=50‚Ç¨, Ca=2‚Ç¨/u¬∑any. Lot √≤ptim?", "EOQ: D=10.000u/a√±o, Cp=50‚Ç¨, Ca=2‚Ç¨/u¬∑a√±o. ¬øLote √≥ptimo?", "EOQ: D=10,000u/yr, Cp=‚Ç¨50, Ca=‚Ç¨2/u¬∑yr. Optimal lot?"), correcta: 707, tolerancia: 15, pista: "‚àö(2√óD√óCp/Ca)" },
            { id: 'emc6', tipus: 'numeric', dificultat: 'facil', pregunta: t("Benefici: Ingressos=200.000‚Ç¨, Costos=150.000‚Ç¨. Benefici?", "Beneficio: Ingresos=200.000‚Ç¨, Costes=150.000‚Ç¨. ¬øBeneficio?", "Profit: Revenue=‚Ç¨200,000, Costs=‚Ç¨150,000. Profit?"), correcta: 50000, tolerancia: 0, pista: "Ingressos - Costos" },
            { id: 'emc7', tipus: 'numeric', dificultat: 'facil', pregunta: t("Salari net: Brut=2.000‚Ç¨, SS=127‚Ç¨, IRPF=300‚Ç¨. Net?", "Salario neto: Bruto=2.000‚Ç¨, SS=127‚Ç¨, IRPF=300‚Ç¨. ¬øNeto?", "Net salary: Gross=‚Ç¨2,000, SS=‚Ç¨127, Tax=‚Ç¨300. Net?"), correcta: 1573, tolerancia: 0, pista: "Brut - SS - IRPF" },
            { id: 'emc8', tipus: 'numeric', dificultat: 'dificil', pregunta: t("Apalancament operatiu: MC=50.000‚Ç¨, BAII=20.000‚Ç¨. Grau?", "Apalancamiento operativo: MC=50.000‚Ç¨, BAII=20.000‚Ç¨. ¬øGrado?", "Operating leverage: CM=‚Ç¨50,000, EBIT=‚Ç¨20,000. Degree?"), correcta: 2.5, tolerancia: 0.1, pista: "MC/BAII" },
            { id: 'emo1', tipus: 'order', dificultat: 'facil', pregunta: t("Pir√†mide Maslow (baix‚Üídalt):", "Pir√°mide Maslow (abajo‚Üíarriba):", "Maslow pyramid (bottom‚Üítop):"), elements: [t("Fisiol√≤giques", "Fisiol√≥gicas", "Physiological"), t("Seguretat", "Seguridad", "Safety"), t("Socials", "Sociales", "Social"), t("Estima", "Estima", "Esteem"), t("Autorealitzaci√≥", "Autorrealizaci√≥n", "Self-actualization")], ordreCorrecte: [0, 1, 2, 3, 4] },
            { id: 'emo2', tipus: 'order', dificultat: 'mitjana', pregunta: t("Cicle vida producte:", "Ciclo vida producto:", "Product life cycle:"), elements: [t("Introducci√≥", "Introducci√≥n", "Introduction"), t("Creixement", "Crecimiento", "Growth"), t("Maduresa", "Madurez", "Maturity"), t("Declivi", "Declive", "Decline")], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'emo3', tipus: 'order', dificultat: 'mitjana', pregunta: t("Proc√©s selecci√≥ personal:", "Proceso selecci√≥n personal:", "Staff selection process:"), elements: [t("An√†lisi lloc", "An√°lisis puesto", "Job analysis"), t("Reclutament", "Reclutamiento", "Recruitment"), t("Entrevistes", "Entrevistas", "Interviews"), t("Contractaci√≥", "Contrataci√≥n", "Hiring")], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'emo4', tipus: 'order', dificultat: 'facil', pregunta: t("Capital m√≠nim (Espanya) menor‚Üímajor:", "Capital m√≠nimo (Espa√±a) menor‚Üímayor:", "Min capital (Spain) low‚Üíhigh:"), elements: [t("Aut√≤nom", "Aut√≥nomo", "Self-empl."), "SL (1‚Ç¨)", "SL (3.000‚Ç¨)", "SA (60.000‚Ç¨)"], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'emi1', tipus: 'identify', dificultat: 'facil', pregunta: t("Identifica la matriu:", "Identifica la matriz:", "Identify the matrix:"), imatge: "bcg", opcions: ["DAFO", "Ansoff", "BCG", "Porter"], correcta: 2 },
            { id: 'emi2', tipus: 'identify', dificultat: 'mitjana', pregunta: t("BCG: Alta quota + Alt creixement =", "BCG: Alta cuota + Alto crecimiento =", "BCG: High share + High growth ="), imatge: "bcg", opcions: [t("Vaca", "Vaca", "Cash Cow"), t("Estrella", "Estrella", "Star"), t("Interrogant", "Interrogante", "Question"), t("Gos", "Perro", "Dog")], correcta: 1 },
            { id: 'emi3', tipus: 'identify', dificultat: 'mitjana', pregunta: t("Ansoff: Producte NOU + Mercat NOU =", "Ansoff: Producto NUEVO + Mercado NUEVO =", "Ansoff: NEW Product + NEW Market ="), imatge: "ansoff", opcions: [t("Penetraci√≥", "Penetraci√≥n", "Penetration"), t("Desenv. mercat", "Desarrollo mercado", "Market dev."), t("Desenv. producte", "Desarrollo producto", "Product dev."), t("Diversificaci√≥", "Diversificaci√≥n", "Diversification")], correcta: 3 },
            { id: 'emi4', tipus: 'identify', dificultat: 'dificil', pregunta: t("Canvas: 'Per qu√® ens trien' =", "Canvas: 'Por qu√© nos eligen' =", "Canvas: 'Why they choose us' ="), imatge: "canvas", opcions: [t("Segments", "Segmentos", "Segments"), t("Proposta valor", "Propuesta valor", "Value prop."), t("Canals", "Canales", "Channels"), t("Recursos", "Recursos", "Resources")], correcta: 1 },
            { id: 'emi5', tipus: 'identify', dificultat: 'facil', pregunta: t("DAFO: Amenaces s√≥n factors...", "DAFO: Amenazas son factores...", "SWOT: Threats are factors..."), imatge: "dafo", opcions: [t("Interns +", "Internos +", "Internal +"), t("Interns -", "Internos -", "Internal -"), t("Externs +", "Externos +", "External +"), t("Externs -", "Externos -", "External -")], correcta: 3 },
            { id: 'emi6', tipus: 'identify', dificultat: 'mitjana', pregunta: t("Porter: Quantes forces?", "Porter: ¬øCu√°ntas fuerzas?", "Porter: How many forces?"), imatge: "porter", opcions: ["3", "4", "5", "6"], correcta: 2 },
            { id: 'emf1', tipus: 'formula', dificultat: 'facil', pregunta: t("Punt Mort = CF / (P - ___)", "Punto Muerto = CF / (P - ___)", "Break-even = FC / (P - ___)"), opcions: ["CVu", "CT", "CF", "MC"], correcta: 0 },
            { id: 'emf2', tipus: 'formula', dificultat: 'mitjana', pregunta: t("Productivitat = ___ / Recursos", "Productividad = ___ / Recursos", "Productivity = ___ / Resources"), opcions: [t("Producci√≥", "Producci√≥n", "Output"), t("Benefici", "Beneficio", "Profit"), t("Vendes", "Ventas", "Sales"), t("Costos", "Costes", "Costs")], correcta: 0 },
            { id: 'emf3', tipus: 'formula', dificultat: 'mitjana', pregunta: t("Cost Total = CF + CVu √ó ___", "Coste Total = CF + CVu √ó ___", "Total Cost = FC + VCu √ó ___"), opcions: ["Q", "P", "MC", "CT"], correcta: 0 },
            { id: 'emf4', tipus: 'formula', dificultat: 'dificil', pregunta: "EOQ = ‚àö(2√óD√óCp / ___)", opcions: ["Ca", "Cv", "CF", "P"], correcta: 0 },
            { id: 'emv1', tipus: 'truefalse', dificultat: 'facil', pregunta: t("SL: responsabilitat limitada al capital aportat", "SL: responsabilidad limitada al capital aportado", "LLC: liability limited to contributed capital"), correcta: true },
            { id: 'emv2', tipus: 'truefalse', dificultat: 'mitjana', pregunta: t("Herzberg: el salari √©s factor MOTIVADOR", "Herzberg: el salario es factor MOTIVADOR", "Herzberg: salary is a MOTIVATING factor"), correcta: false },
        ]
    }), [idioma]);

    useEffect(() => {
        const saved = localStorage.getItem('pde_concurs_ranking_v3');
        if (saved) setRanking(JSON.parse(saved));
    }, []);

    // Inicialitzar estats segons el tipus de pregunta
    useEffect(() => {
        if (fase !== 'jugant' || !preguntesPartida[preguntaActual]) return;
        const p = preguntesPartida[preguntaActual];
        
        if (p.tipus === 'order' || p.tipus === 'match_risk') {
            const elements = p.elements;
            setOrdreUsuari(elements.map((_, i) => i).sort(() => Math.random() - 0.5));
        }
        if (p.tipus === 'allocate') {
            // Inicialitzar amb distribuci√≥ igual
            const n = p.assets.length;
            const equalShare = Math.floor(100 / n);
            const remainder = 100 - (equalShare * n);
            setAllocations(p.assets.map((_, i) => i === 0 ? equalShare + remainder : equalShare));
        }
        if (p.tipus === 'slider_value') {
            setSliderValue(Math.floor((p.min + p.max) / 2));
        }
        if (p.tipus === 'scenario') {
            setSelectedOptions([]);
        }
        if (p.tipus === 'click_chart') {
            setClickedPoint(null);
        }
    }, [preguntaActual, fase, preguntesPartida]);
    
    const obtenirPreguntes = (cat) => {
        let pool = cat === 'totes' 
            ? [...bancPreguntes.economia, ...bancPreguntes.finances, ...bancPreguntes.empresa]
            : [...bancPreguntes[cat]];
        return pool.sort(() => Math.random() - 0.5).slice(0, 20);
    };

    const iniciarPartida = () => {
        if (!nomJugador.trim()) { showToast(t("Introdueix el teu nom!", "¬°Introduce tu nombre!", "Enter your name!"), 'error'); return; }
        setPreguntesPartida(obtenirPreguntes(categoria));
        setPreguntaActual(0); setPuntuacio(0); setRespostes([]); setRatxa(0); setMaxRatxa(0);
        setRespostaUsuari(null); setMostrarResultat(false);
        setOrdreUsuari([]); setTimerKey(k => k + 1); setTimerActive(true);
        setAjudes({ cinquanta: 1, temps: 1, saltar: 1 }); setOpcionsEliminades([]);
        // Resetejar nous estats
        setClickedPoint(null); setAllocations([]); setSliderValue(25); setSelectedOptions([]);
        setFase('jugant');
        playSound('bonus');
    };

    const calcularPunts = (correcta, tempsUsed, dificultat, ratxaActual) => {
        if (!correcta) return -25;
        let base = dificultat === 'facil' ? 100 : dificultat === 'mitjana' ? 150 : 200;
        const tempsRestant = 60 - tempsUsed;
        const bonusVelocitat = tempsRestant > 40 ? Math.floor((tempsRestant - 40) * 3) : 0;
        let mult = ratxaActual >= 7 ? 3 : ratxaActual >= 5 ? 2.5 : ratxaActual >= 3 ? 2 : ratxaActual >= 1 ? 1.5 : 1;
        return Math.floor((base + bonusVelocitat) * mult);
    };

    const handleResposta = useCallback((resposta) => {
        setTimerActive(false);
        const p = preguntesPartida[preguntaActual];
        let ok = false;
        
        // Tipus tradicionals
        if (p.tipus === 'multiple' || p.tipus === 'identify' || p.tipus === 'formula') ok = resposta === p.correcta;
        else if (p.tipus === 'truefalse') ok = resposta === p.correcta;
        else if (p.tipus === 'numeric') ok = Math.abs(parseFloat(resposta) - p.correcta) <= (p.tolerancia || 0);
        else if (p.tipus === 'order' || p.tipus === 'match_risk') ok = JSON.stringify(ordreUsuari) === JSON.stringify(p.ordreCorrecte);
        
        // Nous tipus interactius
        else if (p.tipus === 'click_chart') {
            ok = resposta >= p.correctZone.min && resposta <= p.correctZone.max;
        }
        else if (p.tipus === 'allocate') {
            // Validar que cada assignaci√≥ est√† dins del rang correcte
            ok = allocations.every((val, i) => {
                const range = p.correctRanges[i];
                return val >= range[0] && val <= range[1];
            }) && allocations.reduce((a, b) => a + b, 0) === 100;
        }
        else if (p.tipus === 'scenario') {
            // Validar opcions seleccionades
            const correctes = p.opcions.map((o, i) => o.correcta ? i : -1).filter(i => i >= 0);
            if (p.multipleCorrect) {
                ok = selectedOptions.length > 0 && selectedOptions.every(i => correctes.includes(i));
            } else {
                ok = selectedOptions.length === 1 && correctes.includes(selectedOptions[0]);
            }
        }
        else if (p.tipus === 'slider_value') {
            ok = Math.abs(sliderValue - p.correcta) <= (p.tolerancia || 0);
        }
        
        const tempsUsed = 60 - (document.querySelector('.timer-display')?.textContent?.replace('s','') || 30);
        const novaRatxa = ok ? ratxa + 1 : 0;
        const punts = calcularPunts(ok, tempsUsed, p.dificultat, ratxa);
        
        if (ok) {
            playSound('correct');
            vibrate([100]);
            if (novaRatxa >= 3) showToast(`üî• ${t('Ratxa', 'Racha', 'Streak')} x${novaRatxa}!`, 'success');
        } else {
            playSound('wrong');
            vibrate([100, 50, 100]);
        }
        
        setPointsPopup({ show: true, points: punts });
        setTimeout(() => setPointsPopup({ show: false, points: 0 }), 1000);
        
        setRespostaUsuari(resposta); setMostrarResultat(true); setRatxa(novaRatxa);
        if (novaRatxa > maxRatxa) setMaxRatxa(novaRatxa);
        setPuntuacio(s => Math.max(0, s + punts));
        setRespostes(r => [...r, { pregunta: p.id, correcta: ok, punts, temps: tempsUsed }]);
    }, [preguntesPartida, preguntaActual, ordreUsuari, allocations, selectedOptions, sliderValue, ratxa, maxRatxa, playSound, vibrate, showToast, t]);
    
    // EXPOSAR handleResposta GLOBALMENT per l'input HTML flotant
    useEffect(() => {
        window.submitNumericAnswer = (value) => {
            if (fase === 'jugant' && !mostrarResultat) {
                handleResposta(value);
            }
        };
        return () => { delete window.submitNumericAnswer; };
    }, [fase, mostrarResultat, handleResposta]);

    const handleTimeUp = useCallback(() => {
        if (!mostrarResultat) handleResposta(null);
    }, [mostrarResultat, handleResposta]);

    const seguentPregunta = () => {
        setOpcionsEliminades([]);
        if (preguntaActual + 1 >= preguntesPartida.length) {
            const entry = { nom: nomJugador, punts: puntuacio, data: new Date().toLocaleDateString('ca-ES'), correctes: respostes.filter(r => r.correcta).length, categoria, maxRatxa };
            const nouRanking = [...ranking, entry].sort((a, b) => b.punts - a.punts).slice(0, 10);
            setRanking(nouRanking);
            localStorage.setItem('pde_concurs_ranking_v3', JSON.stringify(nouRanking));
            setShowConfetti(true);
            setTimeout(() => setShowConfetti(false), 4000);
            playSound('bonus');
            setFase('resultats');
        } else {
            setPreguntaActual(p => p + 1);
            setRespostaUsuari(null); setMostrarResultat(false);
            setOrdreUsuari([]);
            // Resetejar nous estats interactius
            setClickedPoint(null);
            setAllocations([]);
            setSliderValue(25);
            setSelectedOptions([]);
            setTimerKey(k => k + 1); setTimerActive(true);
        }
    };

    // AJUDES
    const usarAjuda50 = () => {
        if (ajudes.cinquanta <= 0 || mostrarResultat) return;
        const p = preguntesPartida[preguntaActual];
        if (p.tipus !== 'multiple' && p.tipus !== 'identify' && p.tipus !== 'formula') {
            showToast(t("Nom√©s per preguntes tipus test!", "¬°Solo para preguntas tipo test!", "Only for multiple choice!"), 'error');
            return;
        }
        const incorrectes = p.opcions.map((_, i) => i).filter(i => i !== p.correcta);
        const aEliminar = incorrectes.sort(() => Math.random() - 0.5).slice(0, 2);
        setOpcionsEliminades(aEliminar);
        setAjudes(a => ({ ...a, cinquanta: a.cinquanta - 1 }));
        showToast(t("50:50 activat!", "¬°50:50 activado!", "50:50 activated!"), 'success');
        playSound('tick');
    };
    
    const usarAjudaTemps = () => {
        if (ajudes.temps <= 0 || mostrarResultat) return;
        // Afegir 60 segons al temps actual via DOM directe
        if (window.addTimerTime) window.addTimerTime(60);
        setAjudes(a => ({ ...a, temps: a.temps - 1 }));
        showToast(t("+60 segons!", "¬°+60 segundos!", "+60 seconds!"), 'success');
        playSound('bonus');
    };
    
    const usarAjudaSaltar = () => {
        if (ajudes.saltar <= 0 || mostrarResultat) return;
        setAjudes(a => ({ ...a, saltar: a.saltar - 1 }));
        showToast(t("Pregunta saltada!", "¬°Pregunta saltada!", "Question skipped!"), 'info');
        seguentPregunta();
    };

    const moureElement = (index, dir) => {
        const nou = [...ordreUsuari];
        const newIdx = index + dir;
        if (newIdx < 0 || newIdx >= nou.length) return;
        [nou[index], nou[newIdx]] = [nou[newIdx], nou[index]];
        setOrdreUsuari(nou);
        playSound('tick');
    };

    const Card = ({ children, className = "" }) => (
        <div className={`bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 ${className}`}>{children}</div>
    );

    const renderGrafic = (tipus) => {
        const grafics = {
            bcg: (<div className="grid grid-cols-2 gap-2 w-52 mx-auto my-4 text-xs"><div className="p-3 bg-yellow-400/30 rounded-lg text-center border border-yellow-400/50 animate-pulse">‚≠ê Stars</div><div className="p-3 bg-purple-400/30 rounded-lg text-center border border-purple-400/50">‚ùì ?</div><div className="p-3 bg-green-400/30 rounded-lg text-center border border-green-400/50">üêÑ Cash Cows</div><div className="p-3 bg-slate-400/30 rounded-lg text-center border border-slate-400/50">üêï Dogs</div><div className="col-span-2 text-center text-purple-300 text-[10px] mt-1">‚Üê {t("Quota", "Cuota", "Share")} ‚Üí</div></div>),
            ansoff: (<div className="w-56 mx-auto my-4 text-xs"><div className="grid grid-cols-3 gap-1"><div></div><div className="text-center text-purple-300 text-[10px]">{t("Prod. actual", "Prod. actual", "Current prod.")}</div><div className="text-center text-purple-300 text-[10px]">{t("Prod. nou", "Prod. nuevo", "New prod.")}</div><div className="text-purple-300 text-[10px]">{t("Mercat actual", "Mercado actual", "Current mkt")}</div><div className="p-2 bg-green-400/30 rounded border border-green-400/50 text-center">{t("Penetr.", "Penetr.", "Penetr.")}</div><div className="p-2 bg-amber-400/30 rounded border border-amber-400/50 text-center">{t("Des.Prod", "Des.Prod", "Prod.Dev")}</div><div className="text-purple-300 text-[10px]">{t("Mercat nou", "Mercado nuevo", "New mkt")}</div><div className="p-2 bg-blue-400/30 rounded border border-blue-400/50 text-center">{t("Des.Mkt", "Des.Mkt", "Mkt.Dev")}</div><div className="p-2 bg-red-400/30 rounded border border-red-400/50 text-center animate-pulse">{t("Divers.", "Divers.", "Divers.")}</div></div></div>),
            canvas: (<div className="grid grid-cols-5 gap-1 w-72 mx-auto my-4 text-[10px]"><div className="row-span-2 p-2 bg-violet-400/30 rounded border border-violet-400/50 text-center">ü§ù</div><div className="p-2 bg-blue-400/30 rounded border border-blue-400/50 text-center">‚öôÔ∏è</div><div className="row-span-2 p-2 bg-pink-400/30 rounded border border-pink-400/50 text-center animate-pulse">üíé</div><div className="p-2 bg-green-400/30 rounded border border-green-400/50 text-center">‚ù§Ô∏è</div><div className="row-span-2 p-2 bg-emerald-400/30 rounded border border-emerald-400/50 text-center">üë•</div><div className="p-2 bg-cyan-400/30 rounded border border-cyan-400/50 text-center">üèóÔ∏è</div><div className="p-2 bg-amber-400/30 rounded border border-amber-400/50 text-center">üì¢</div><div className="col-span-2 p-2 bg-red-400/30 rounded border border-red-400/50 text-center">üí∏</div><div className="col-span-3 p-2 bg-green-400/30 rounded border border-green-400/50 text-center">üí∞</div></div>),
            dafo: (<div className="grid grid-cols-2 gap-2 w-56 mx-auto my-4 text-xs"><div className="p-2 bg-green-400/30 rounded border border-green-400/50 text-center">üí™ {t("F", "F", "S")}</div><div className="p-2 bg-red-400/30 rounded border border-red-400/50 text-center">üò∞ {t("D", "D", "W")}</div><div className="p-2 bg-blue-400/30 rounded border border-blue-400/50 text-center">üéØ {t("O", "O", "O")}</div><div className="p-2 bg-orange-400/30 rounded border border-orange-400/50 text-center animate-pulse">‚ö†Ô∏è {t("A", "A", "T")}</div></div>),
            porter: (<div className="w-56 mx-auto my-4 text-[10px] text-center"><div className="p-2 bg-red-400/30 rounded border border-red-400/50 mb-1">‚¨ÜÔ∏è {t("Entrants", "Entrantes", "Entrants")}</div><div className="flex gap-1"><div className="p-2 bg-blue-400/30 rounded border border-blue-400/50 flex-1">‚¨ÖÔ∏è</div><div className="p-2 bg-purple-400/30 rounded border border-purple-400/50 flex-1">‚öîÔ∏è</div><div className="p-2 bg-green-400/30 rounded border border-green-400/50 flex-1">‚û°Ô∏è</div></div><div className="p-2 bg-amber-400/30 rounded border border-amber-400/50 mt-1">‚¨áÔ∏è {t("Substituts", "Sustitutos", "Substitutes")}</div></div>),
            oferta_demanda: (<div className="w-48 h-32 mx-auto my-4 relative bg-white/5 rounded-lg border border-white/20"><div className="absolute bottom-4 left-4 w-32 h-20 border-l-2 border-b-2 border-purple-400"></div><div className="absolute bottom-6 left-6 w-24 h-1 bg-blue-400 transform -rotate-45 origin-left"></div><div className="absolute bottom-6 left-6 w-24 h-1 bg-red-400 transform rotate-45 origin-left"></div><div className="absolute bottom-2 right-4 text-[10px] text-purple-300">Q</div><div className="absolute top-2 left-2 text-[10px] text-purple-300">P</div><div className="absolute top-1/2 left-1/2 w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div></div>),
            islm: (<div className="w-48 h-32 mx-auto my-4 relative bg-white/5 rounded-lg border border-white/20"><div className="absolute bottom-4 left-4 w-32 h-20 border-l-2 border-b-2 border-purple-400"></div><div className="absolute bottom-8 left-8 w-20 h-1 bg-blue-400" style={{transform:'rotate(-25deg)'}}></div><div className="absolute bottom-16 left-10 w-20 h-1 bg-green-400" style={{transform:'rotate(25deg)'}}></div><div className="absolute top-4 left-10 text-[10px] text-blue-300 font-bold">IS</div><div className="absolute top-8 right-8 text-[10px] text-green-300 font-bold">LM</div></div>),
            laffer: (<div className="w-48 h-32 mx-auto my-4 relative bg-white/5 rounded-lg border border-white/20"><div className="absolute bottom-4 left-4 w-32 h-20 border-l-2 border-b-2 border-purple-400"></div><svg className="absolute bottom-6 left-6 w-28 h-16" viewBox="0 0 100 60"><path d="M 0 60 Q 50 -20 100 60" stroke="#f59e0b" strokeWidth="3" fill="none"/><circle cx="50" cy="10" r="4" fill="#fbbf24" className="animate-pulse"/></svg></div>),
            balanc: (<div className="w-56 mx-auto my-4 text-[10px]"><div className="flex gap-1"><div className="flex-1 p-2 bg-blue-400/30 rounded-t border border-blue-400/50 text-center font-bold">{t("ACTIU", "ACTIVO", "ASSETS")}</div><div className="flex-1 p-2 bg-green-400/30 rounded-t border border-green-400/50 text-center font-bold">{t("P+PN", "P+PN", "L+E")}</div></div><div className="flex gap-1"><div className="flex-1 p-1 bg-blue-400/20 border-x border-blue-400/50">ANC</div><div className="flex-1 p-1 bg-green-400/20 border-x border-green-400/50">PN</div></div><div className="flex gap-1"><div className="flex-1 p-1 bg-blue-400/20 border border-blue-400/50 rounded-b">AC</div><div className="flex-1"><div className="p-1 bg-green-400/20 border-x border-green-400/50">PNC</div><div className="p-1 bg-green-400/20 border border-green-400/50 rounded-b">PC</div></div></div></div>),
            leasing: (<div className="w-48 mx-auto my-4 p-4 bg-blue-400/20 rounded-xl border border-blue-400/50 text-center"><span className="text-3xl">üè¶‚û°Ô∏èüì¶</span><p className="text-sm mt-2 text-blue-200 font-bold">LEASING</p></div>),
            factoring: (<div className="w-48 mx-auto my-4 p-4 bg-green-400/20 rounded-xl border border-green-400/50 text-center"><span className="text-3xl">üìÑ‚û°Ô∏èüíµ</span><p className="text-sm mt-2 text-green-200 font-bold">FACTORING</p></div>),
        };
        return grafics[tipus] || null;
    };

    // PANTALLA INICI
    const PantallaInici = () => (
        <div className="max-w-2xl mx-auto space-y-6 animate-fade">
            <div className="text-center py-8">
                <span className="text-7xl mb-6 block animate-bounce">üèÜ</span>
                <h1 className="text-5xl font-black text-white mb-3">{t("Concurs PDE", "Concurso PDE", "PDE Contest")}</h1>
                <p className="text-xl text-purple-200">{t("Economia ¬∑ Finances ¬∑ Empresa", "Econom√≠a ¬∑ Finanzas ¬∑ Empresa", "Economics ¬∑ Finance ¬∑ Business")}</p>
            </div>
            
            <Card>
                <div className="space-y-5">
                    <div>
                        <label className="block text-sm font-semibold text-purple-200 mb-2">{t("El teu nom", "Tu nombre", "Your name")}</label>
                        <input type="text" value={nomJugador} onChange={e => setNomJugador(e.target.value)} placeholder={t("Escriu el teu nom...", "Escribe tu nombre...", "Enter your name...")} className="w-full p-4 bg-white/10 border border-white/30 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 outline-none text-lg" maxLength={20} />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-semibold text-purple-200 mb-3">{t("Categoria", "Categor√≠a", "Category")}</label>
                        <div className="grid grid-cols-2 gap-3">
                            {[
                                { id: 'economia', icon: 'üìà', label: t('Economia', 'Econom√≠a', 'Economics'), color: 'from-blue-500 to-cyan-500' },
                                { id: 'finances', icon: 'üí∞', label: t('Finances', 'Finanzas', 'Finance'), color: 'from-green-500 to-emerald-500' },
                                { id: 'empresa', icon: 'üè¢', label: t('Empresa', 'Empresa', 'Business'), color: 'from-orange-500 to-red-500' },
                                { id: 'totes', icon: 'üéØ', label: t('Totes', 'Todas', 'All'), color: 'from-purple-500 to-pink-500' },
                            ].map(cat => (
                                <button key={cat.id} onClick={() => { setCategoria(cat.id); playSound('tick'); }} className={`p-4 rounded-xl border-2 transition-all transform hover:scale-105 ${categoria === cat.id ? 'border-yellow-400 bg-gradient-to-r ' + cat.color + ' shadow-lg shadow-yellow-400/30 animate-glow' : 'border-white/30 bg-white/5 hover:bg-white/10'}`}>
                                    <span className="text-3xl block mb-2">{cat.icon}</span>
                                    <span className="font-bold text-white">{cat.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <button onClick={iniciarPartida} className="w-full py-5 gold-gradient text-slate-900 font-black text-xl rounded-xl hover:opacity-90 transition-all shadow-lg shadow-yellow-500/30 transform hover:scale-[1.02] animate-glow">
                        üöÄ {t("COMEN√áAR!", "¬°EMPEZAR!", "START!")}
                    </button>
                </div>
            </Card>
            
            <Card>
                <p className="text-sm text-purple-300 mb-3 text-center font-semibold">{t("Ajudes disponibles:", "Ayudas disponibles:", "Available helps:")}</p>
                <div className="grid grid-cols-3 gap-3 text-center">
                    <div className="p-3 bg-blue-500/20 rounded-xl border border-blue-400/50"><span className="text-2xl block mb-1">5Ô∏è‚É£0Ô∏è‚É£</span><span className="text-xs text-blue-300">50:50</span></div>
                    <div className="p-3 bg-green-500/20 rounded-xl border border-green-400/50"><span className="text-2xl block mb-1">‚è±Ô∏è</span><span className="text-xs text-green-300">+60s</span></div>
                    <div className="p-3 bg-amber-500/20 rounded-xl border border-amber-400/50"><span className="text-2xl block mb-1">‚è≠Ô∏è</span><span className="text-xs text-amber-300">{t("Saltar", "Saltar", "Skip")}</span></div>
                </div>
            </Card>
            
            <div className="flex gap-3">
                <button onClick={() => setFase('ranking')} className="flex-1 py-4 bg-white/10 border border-white/30 text-white font-bold rounded-xl hover:bg-white/20 transition-all">üèÜ Ranking</button>
                <a href="./index.html" className="flex-1 py-4 bg-white/10 border border-white/30 text-white font-bold rounded-xl hover:bg-white/20 text-center transition-all">üè† {t("Inici", "Inicio", "Home")}</a>
            </div>
            
            <div className="flex justify-center items-center gap-4">
                <div className="flex gap-2">
                    {['val', 'es', 'en'].map(lang => (
                        <button key={lang} onClick={() => setIdioma(lang)} className={`px-4 py-2 rounded-lg font-bold transition-all ${idioma === lang ? 'bg-yellow-400 text-slate-900' : 'bg-white/10 text-white hover:bg-white/20'}`}>{lang.toUpperCase()}</button>
                    ))}
                </div>
                <button onClick={() => setSoundEnabled(!soundEnabled)} className={`p-2 rounded-lg ${soundEnabled ? 'bg-green-500/30 text-green-300' : 'bg-red-500/30 text-red-300'}`}>
                    {soundEnabled ? 'üîä' : 'üîá'}
                </button>
            </div>
        </div>
    );

    // PANTALLA JOC
    const PantallaJoc = () => {
        const p = preguntesPartida[preguntaActual];
        if (!p) return null;
        const progressPct = ((preguntaActual + 1) / preguntesPartida.length) * 100;
        const tipusIcons = { 
            numeric: 'üßÆ', order: 'üî¢', formula: 'üìù', identify: 'üìä', truefalse: '‚úì‚úó', multiple: 'üîò',
            click_chart: 'üìà', allocate: 'üíº', scenario: 'üé≠', slider_value: 'üéöÔ∏è', match_risk: 'üéØ'
        };
        
        return (
            <div className="max-w-3xl mx-auto space-y-4 animate-fade">
                {/* Header */}
                <div className="flex items-center justify-between bg-white/10 backdrop-blur rounded-xl p-3 border border-white/20">
                    <div className="flex items-center gap-2">
                        <span className="font-bold text-white bg-white/20 px-3 py-1 rounded-lg">{preguntaActual + 1}/{preguntesPartida.length}</span>
                        <div className="flex items-center gap-1 bg-yellow-400/20 text-yellow-400 px-3 py-1 rounded-lg">
                            <span>üèÜ</span><span className="font-bold">{puntuacio}</span>
                        </div>
                        {ratxa >= 1 && (
                            <div className={`flex items-center gap-1 px-3 py-1 rounded-lg ${ratxa >= 5 ? 'bg-red-500/30 text-red-400 streak-fire' : ratxa >= 3 ? 'bg-orange-400/30 text-orange-400' : 'bg-amber-400/20 text-amber-400'}`}>
                                <span>{ratxa >= 5 ? 'üî•üî•' : ratxa >= 3 ? 'üî•' : '‚ú®'}</span>
                                <span className="font-bold">x{ratxa >= 7 ? '3' : ratxa >= 5 ? '2.5' : ratxa >= 3 ? '2' : '1.5'}</span>
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Timer i Progr√©s */}
                <div className="space-y-2">
                    <div className="h-2 bg-white/20 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300" style={{ width: `${progressPct}%` }}></div>
                    </div>
                    <TimerDirect timerKey={timerKey} onTimeUp={handleTimeUp} isActive={timerActive && !mostrarResultat} />
                </div>
                
                {/* Ajudes */}
                {!mostrarResultat && (
                    <div className="flex justify-center gap-2">
                        <button onClick={usarAjuda50} disabled={ajudes.cinquanta <= 0} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${ajudes.cinquanta > 0 ? 'bg-blue-500/30 text-blue-300 hover:bg-blue-500/50' : 'bg-white/10 text-white/30 cursor-not-allowed'}`}>
                            5Ô∏è‚É£0Ô∏è‚É£ ({ajudes.cinquanta})
                        </button>
                        <button onClick={usarAjudaTemps} disabled={ajudes.temps <= 0} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${ajudes.temps > 0 ? 'bg-green-500/30 text-green-300 hover:bg-green-500/50' : 'bg-white/10 text-white/30 cursor-not-allowed'}`}>
                            ‚è±Ô∏è +60s ({ajudes.temps})
                        </button>
                        <button onClick={usarAjudaSaltar} disabled={ajudes.saltar <= 0} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${ajudes.saltar > 0 ? 'bg-amber-500/30 text-amber-300 hover:bg-amber-500/50' : 'bg-white/10 text-white/30 cursor-not-allowed'}`}>
                            ‚è≠Ô∏è ({ajudes.saltar})
                        </button>
                    </div>
                )}
                
                {/* Pregunta */}
                <Card className={mostrarResultat ? (respostes[respostes.length - 1]?.correcta ? 'animate-correct' : 'animate-wrong') : ''}>
                    <div className="flex items-center gap-2 mb-4">
                        <span className={`px-3 py-1 rounded-lg text-xs font-bold ${p.dificultat === 'facil' ? 'bg-green-400/30 text-green-300' : p.dificultat === 'mitjana' ? 'bg-amber-400/30 text-amber-300' : 'bg-red-400/30 text-red-300'}`}>
                            {p.dificultat === 'facil' ? '‚≠ê' : p.dificultat === 'mitjana' ? '‚≠ê‚≠ê' : '‚≠ê‚≠ê‚≠ê'}
                        </span>
                        <span className="text-lg">{tipusIcons[p.tipus]}</span>
                    </div>
                    
                    <h3 className="text-xl md:text-2xl font-bold text-white mb-6">{p.pregunta}</h3>
                    
                    {p.imatge && renderGrafic(p.imatge)}
                    
                    {/* Opcions m√∫ltiples/identify/formula */}
                    {(p.tipus === 'multiple' || p.tipus === 'identify' || p.tipus === 'formula') && (
                        <div className="grid gap-3">
                            {p.opcions.map((op, i) => {
                                if (opcionsEliminades.includes(i)) return (
                                    <div key={i} className="p-4 rounded-xl border-2 border-white/10 bg-white/5 opacity-30 line-through text-white/50">{op}</div>
                                );
                                return (
                                    <button key={i} onClick={() => !mostrarResultat && handleResposta(i)} disabled={mostrarResultat}
                                        className={`p-4 text-left rounded-xl border-2 transition-all font-medium text-white ${
                                            mostrarResultat ? i === p.correcta ? 'border-green-400 bg-green-400/30' : respostaUsuari === i ? 'border-red-400 bg-red-400/30' : 'border-white/20 opacity-40'
                                            : 'border-white/30 hover:border-yellow-400 hover:bg-white/10 cursor-pointer active:scale-95'
                                        }`}>
                                        <span className="font-bold mr-3 text-purple-300">{String.fromCharCode(65 + i)}.</span>{op}
                                        {mostrarResultat && i === p.correcta && <span className="float-right text-green-400 text-xl">‚úì</span>}
                                        {mostrarResultat && respostaUsuari === i && i !== p.correcta && <span className="float-right text-red-400 text-xl">‚úó</span>}
                                    </button>
                                );
                            })}
                        </div>
                    )}
                    
                    {/* Vertader/Fals */}
                    {p.tipus === 'truefalse' && (
                        <div className="grid grid-cols-2 gap-4">
                            {[true, false].map(val => (
                                <button key={String(val)} onClick={() => !mostrarResultat && handleResposta(val)} disabled={mostrarResultat}
                                    className={`p-6 rounded-xl border-2 transition-all font-bold text-xl text-white active:scale-95 ${
                                        mostrarResultat ? val === p.correcta ? 'border-green-400 bg-green-400/30' : respostaUsuari === val ? 'border-red-400 bg-red-400/30' : 'border-white/20 opacity-40'
                                        : 'border-white/30 hover:border-yellow-400 hover:bg-white/10 cursor-pointer'
                                    }`}>
                                    {val ? '‚úì ' + t('VERTADER', 'VERDADERO', 'TRUE') : '‚úó ' + t('FALS', 'FALSO', 'FALSE')}
                                </button>
                            ))}
                        </div>
                    )}
                    
                    {/* Num√®ric - L'input real est√† fixat a baix de la pantalla */}
                    {p.tipus === 'numeric' && (
                        <div className="space-y-4">
                            {!mostrarResultat ? (
                                <div className="text-center py-8 text-purple-300">
                                    <span className="text-4xl block mb-3">‚¨áÔ∏è</span>
                                    <p className="text-lg">{t("Escriu la resposta a baix", "Escribe la respuesta abajo", "Type your answer below")}</p>
                                </div>
                            ) : (
                                <div className="text-center py-4">
                                    <p className="text-lg text-white">{t("Resposta:", "Respuesta:", "Answer:")} <strong className="text-green-400 text-2xl">{p.correcta}</strong></p>
                                    {p.pista && <p className="text-sm text-purple-300 mt-2">üí° {p.pista}</p>}
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Ordenar */}
                    {p.tipus === 'order' && (
                        <div className="space-y-4">
                            <div className="space-y-2">
                                {ordreUsuari.map((elemIdx, pos) => (
                                    <div key={pos} className={`flex items-center gap-3 p-4 rounded-xl border-2 transition-all ${mostrarResultat ? pos === p.ordreCorrecte.indexOf(elemIdx) ? 'border-green-400 bg-green-400/20' : 'border-red-400 bg-red-400/20' : 'border-white/30 bg-white/5'}`}>
                                        <span className="font-bold text-purple-300 w-8 text-lg">{pos + 1}.</span>
                                        <span className="flex-1 font-medium text-white">{p.elements[elemIdx]}</span>
                                        {!mostrarResultat && (
                                            <div className="flex gap-2">
                                                <button onClick={() => moureElement(pos, -1)} disabled={pos === 0} className="w-12 h-12 rounded-lg bg-white/20 hover:bg-white/30 disabled:opacity-30 text-white font-bold text-xl active:scale-90">‚ñ≤</button>
                                                <button onClick={() => moureElement(pos, 1)} disabled={pos === ordreUsuari.length - 1} className="w-12 h-12 rounded-lg bg-white/20 hover:bg-white/30 disabled:opacity-30 text-white font-bold text-xl active:scale-90">‚ñº</button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            {!mostrarResultat && <button onClick={() => handleResposta('order')} className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95">{t("CONFIRMAR", "CONFIRMAR", "CONFIRM")}</button>}
                        </div>
                    )}
                    
                    {/* CLICK_CHART - Gr√†fic clicable */}
                    {p.tipus === 'click_chart' && (
                        <div className="space-y-4">
                            <div className="bg-white/5 rounded-xl p-4 border border-white/20">
                                <div className="relative h-48">
                                    {/* Eix Y */}
                                    <div className="absolute left-0 top-0 bottom-8 w-8 flex flex-col justify-between text-xs text-purple-300">
                                        <span>{Math.max(...p.chartData)}</span>
                                        <span>{Math.min(...p.chartData)}</span>
                                    </div>
                                    {/* Gr√†fic */}
                                    <div className="ml-10 h-40 flex items-end gap-1">
                                        {p.chartData.map((val, i) => {
                                            const height = ((val - Math.min(...p.chartData)) / (Math.max(...p.chartData) - Math.min(...p.chartData))) * 100;
                                            const isClicked = clickedPoint === i;
                                            const isCorrect = i >= p.correctZone.min && i <= p.correctZone.max;
                                            return (
                                                <button key={i} onClick={() => !mostrarResultat && setClickedPoint(i)} disabled={mostrarResultat}
                                                    className={`flex-1 rounded-t-lg transition-all relative group ${
                                                        mostrarResultat 
                                                            ? isCorrect ? 'bg-green-500' : isClicked ? 'bg-red-500' : 'bg-blue-500/50'
                                                            : isClicked ? 'bg-yellow-400 ring-2 ring-yellow-300' : 'bg-blue-500 hover:bg-blue-400'
                                                    }`}
                                                    style={{ height: `${Math.max(height, 10)}%` }}>
                                                    {isClicked && !mostrarResultat && <span className="absolute -top-6 left-1/2 -translate-x-1/2 text-yellow-400">üìç</span>}
                                                    <span className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] text-purple-300 opacity-0 group-hover:opacity-100">{val}</span>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                            {!mostrarResultat && clickedPoint !== null && (
                                <button onClick={() => handleResposta(clickedPoint)} className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95">
                                    {t("CONFIRMAR SELECCI√ì", "CONFIRMAR SELECCI√ìN", "CONFIRM SELECTION")}
                                </button>
                            )}
                            {mostrarResultat && p.pista && <p className="text-sm text-purple-300 text-center">üí° {p.pista}</p>}
                        </div>
                    )}
                    
                    {/* ALLOCATE - Distribuir cartera */}
                    {p.tipus === 'allocate' && (
                        <div className="space-y-4">
                            {p.assets.map((asset, i) => {
                                const canDecrease = allocations[i] >= 5;
                                const canIncrease = allocations.some((val, j) => j !== i && val >= 5);
                                
                                return (
                                    <div key={i} className={`p-4 rounded-xl border-2 transition-all ${
                                        mostrarResultat 
                                            ? (allocations[i] >= p.correctRanges[i][0] && allocations[i] <= p.correctRanges[i][1]) 
                                                ? 'border-green-400 bg-green-400/20' 
                                                : 'border-red-400 bg-red-400/20'
                                            : 'border-white/30 bg-white/5'
                                    }`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-lg">
                                                <span className="mr-2">{asset.icon}</span>
                                                <span className="text-white font-medium">{asset.nom}</span>
                                            </span>
                                            <div className="flex items-center gap-2">
                                                {!mostrarResultat && (
                                                    <button 
                                                        onClick={() => {
                                                            if (!canDecrease) return;
                                                            const newAllocs = [...allocations];
                                                            newAllocs[i] -= 5;
                                                            // Afegir 5 al seg√ºent que tingui menys de 100
                                                            for (let j = 0; j < newAllocs.length; j++) {
                                                                if (j !== i) {
                                                                    newAllocs[j] += 5;
                                                                    break;
                                                                }
                                                            }
                                                            setAllocations(newAllocs);
                                                        }} 
                                                        disabled={!canDecrease}
                                                        className={`w-10 h-10 rounded-lg font-bold text-xl active:scale-90 transition-all ${canDecrease ? 'bg-red-500/30 text-red-300 hover:bg-red-500/50' : 'bg-white/10 text-white/30 cursor-not-allowed'}`}>
                                                        ‚àí
                                                    </button>
                                                )}
                                                <span className="text-2xl font-black text-white min-w-[70px] text-center">{allocations[i]}%</span>
                                                {!mostrarResultat && (
                                                    <button 
                                                        onClick={() => {
                                                            if (!canIncrease) return;
                                                            const newAllocs = [...allocations];
                                                            newAllocs[i] += 5;
                                                            // Treure 5 del primer que tingui >=5
                                                            for (let j = 0; j < newAllocs.length; j++) {
                                                                if (j !== i && newAllocs[j] >= 5) {
                                                                    newAllocs[j] -= 5;
                                                                    break;
                                                                }
                                                            }
                                                            setAllocations(newAllocs);
                                                        }}
                                                        disabled={!canIncrease}
                                                        className={`w-10 h-10 rounded-lg font-bold text-xl active:scale-90 transition-all ${canIncrease ? 'bg-green-500/30 text-green-300 hover:bg-green-500/50' : 'bg-white/10 text-white/30 cursor-not-allowed'}`}>
                                                        +
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        {/* Barra visual */}
                                        <div className="h-4 bg-white/10 rounded-full overflow-hidden">
                                            <div 
                                                className={`h-full transition-all duration-200 ${
                                                    mostrarResultat 
                                                        ? (allocations[i] >= p.correctRanges[i][0] && allocations[i] <= p.correctRanges[i][1]) 
                                                            ? 'bg-green-500' : 'bg-red-500'
                                                        : 'bg-gradient-to-r from-yellow-400 to-amber-500'
                                                }`}
                                                style={{ width: `${allocations[i]}%` }}
                                            ></div>
                                        </div>
                                        {mostrarResultat && (
                                            <div className="text-sm text-purple-300 mt-1">
                                                {t("Rang correcte:", "Rango correcto:", "Correct range:")} {p.correctRanges[i][0]}-{p.correctRanges[i][1]}%
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            <div className="text-center text-lg font-bold text-green-400">
                                {t("Total:", "Total:", "Total:")} {allocations.reduce((a, b) => a + b, 0)}% ‚úì
                            </div>
                            {!mostrarResultat && (
                                <button onClick={() => handleResposta('allocate')} className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95">
                                    {t("CONFIRMAR", "CONFIRMAR", "CONFIRM")}
                                </button>
                            )}
                            {mostrarResultat && p.pista && <p className="text-sm text-purple-300 text-center">üí° {p.pista}</p>}
                        </div>
                    )}
                    
                    {/* SCENARIO - Escenaris de decisi√≥ */}
                    {p.tipus === 'scenario' && (
                        <div className="space-y-3">
                            {p.multipleCorrect && !mostrarResultat && (
                                <p className="text-sm text-amber-300 text-center">‚ö†Ô∏è {t("Pots seleccionar m√∫ltiples opcions", "Puedes seleccionar m√∫ltiples opciones", "You can select multiple options")}</p>
                            )}
                            {p.opcions.map((op, i) => {
                                const isSelected = selectedOptions.includes(i);
                                const isCorrect = op.correcta;
                                return (
                                    <button key={i} 
                                        onClick={() => {
                                            if (mostrarResultat) return;
                                            if (p.multipleCorrect) {
                                                setSelectedOptions(isSelected ? selectedOptions.filter(x => x !== i) : [...selectedOptions, i]);
                                            } else {
                                                setSelectedOptions([i]);
                                            }
                                            playSound('tick');
                                        }}
                                        disabled={mostrarResultat}
                                        className={`w-full p-4 text-left rounded-xl border-2 transition-all ${
                                            mostrarResultat 
                                                ? isCorrect ? 'border-green-400 bg-green-400/30' : isSelected ? 'border-red-400 bg-red-400/30' : 'border-white/20 opacity-40'
                                                : isSelected ? 'border-yellow-400 bg-yellow-400/20' : 'border-white/30 hover:border-white/50'
                                        }`}>
                                        <span className="text-2xl mr-3">{op.icon}</span>
                                        <span className="text-white font-medium">{op.text}</span>
                                        {isSelected && !mostrarResultat && <span className="float-right text-yellow-400">‚úì</span>}
                                        {mostrarResultat && isCorrect && <span className="float-right text-green-400">‚úì</span>}
                                        {mostrarResultat && isSelected && !isCorrect && <span className="float-right text-red-400">‚úó</span>}
                                    </button>
                                );
                            })}
                            {!mostrarResultat && selectedOptions.length > 0 && (
                                <button onClick={() => handleResposta('scenario')} className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95">
                                    {t("CONFIRMAR", "CONFIRMAR", "CONFIRM")}
                                </button>
                            )}
                            {mostrarResultat && p.pista && <p className="text-sm text-purple-300 text-center mt-4">üí° {p.pista}</p>}
                        </div>
                    )}
                    
                    {/* SLIDER_VALUE - Ajusta el valor */}
                    {p.tipus === 'slider_value' && (
                        <div className="space-y-6">
                            <div className="bg-white/5 rounded-xl p-6 border border-white/20">
                                <div className="text-center mb-4">
                                    <span className={`text-6xl font-black ${mostrarResultat ? (Math.abs(sliderValue - p.correcta) <= (p.tolerancia || 0) ? 'text-green-400' : 'text-red-400') : 'text-yellow-400'}`}>
                                        {sliderValue}
                                    </span>
                                </div>
                                {!mostrarResultat ? (
                                    <input type="range" min={p.min} max={p.max} value={sliderValue}
                                        onChange={(e) => setSliderValue(parseInt(e.target.value))}
                                        className="w-full h-4 bg-white/20 rounded-lg appearance-none cursor-pointer accent-yellow-400" />
                                ) : (
                                    <div className="text-center text-lg text-purple-300">
                                        {t("Resposta correcta:", "Respuesta correcta:", "Correct answer:")} <strong className="text-green-400">{p.correcta}</strong>
                                    </div>
                                )}
                                <div className="flex justify-between text-sm text-purple-300 mt-2">
                                    <span>{p.labels?.left || p.min}</span>
                                    <span>{p.labels?.right || p.max}</span>
                                </div>
                            </div>
                            {!mostrarResultat && (
                                <button onClick={() => handleResposta(sliderValue)} className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95">
                                    {t("CONFIRMAR", "CONFIRMAR", "CONFIRM")}
                                </button>
                            )}
                            {mostrarResultat && p.pista && <p className="text-sm text-purple-300 text-center">üí° {p.pista}</p>}
                        </div>
                    )}
                    
                    {/* MATCH_RISK - Ordenar per risc (reutilitza ordre) */}
                    {p.tipus === 'match_risk' && (
                        <div className="space-y-4">
                            <div className="flex justify-between text-sm text-purple-300 px-2">
                                <span>üõ°Ô∏è {t("Menys risc", "Menos riesgo", "Less risk")}</span>
                                <span>{t("M√©s risc", "M√°s riesgo", "More risk")} üé¢</span>
                            </div>
                            <div className="space-y-2">
                                {ordreUsuari.map((elemIdx, pos) => (
                                    <div key={pos} className={`flex items-center gap-3 p-4 rounded-xl border-2 transition-all ${
                                        mostrarResultat 
                                            ? p.ordreCorrecte[pos] === elemIdx ? 'border-green-400 bg-green-400/20' : 'border-red-400 bg-red-400/20' 
                                            : 'border-white/30 bg-white/5'
                                    }`}>
                                        <span className="text-2xl">{p.elements[elemIdx].icon}</span>
                                        <span className="flex-1 font-medium text-white">{p.elements[elemIdx].nom}</span>
                                        <span className={`text-sm px-2 py-1 rounded ${pos < 2 ? 'bg-green-500/30 text-green-300' : pos < 4 ? 'bg-yellow-500/30 text-yellow-300' : 'bg-red-500/30 text-red-300'}`}>
                                            {pos + 1}
                                        </span>
                                        {!mostrarResultat && (
                                            <div className="flex gap-1">
                                                <button onClick={() => moureElement(pos, -1)} disabled={pos === 0} className="w-10 h-10 rounded-lg bg-white/20 hover:bg-white/30 disabled:opacity-30 text-white font-bold active:scale-90">‚ñ≤</button>
                                                <button onClick={() => moureElement(pos, 1)} disabled={pos === ordreUsuari.length - 1} className="w-10 h-10 rounded-lg bg-white/20 hover:bg-white/30 disabled:opacity-30 text-white font-bold active:scale-90">‚ñº</button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            {!mostrarResultat && <button onClick={() => handleResposta('match_risk')} className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95">{t("CONFIRMAR", "CONFIRMAR", "CONFIRM")}</button>}
                        </div>
                    )}
                    
                    {/* Bot√≥ seg√ºent */}
                    {mostrarResultat && (
                        <div className="mt-6 pt-6 border-t border-white/20">
                            <button onClick={seguentPregunta} className="w-full py-5 gold-gradient text-slate-900 font-black text-lg rounded-xl hover:opacity-90 transform hover:scale-[1.02] transition-all active:scale-95">
                                {preguntaActual + 1 >= preguntesPartida.length ? `üèÜ ${t('RESULTATS', 'RESULTADOS', 'RESULTS')}` : `${t('SEG√úENT', 'SIGUIENTE', 'NEXT')} ‚Üí`}
                            </button>
                        </div>
                    )}
                </Card>
            </div>
        );
    };

    // PANTALLA RESULTATS
    const PantallaResultats = () => {
        const correctes = respostes.filter(r => r.correcta).length;
        const pct = ((correctes / respostes.length) * 100).toFixed(0);
        const tempsTotal = respostes.reduce((acc, r) => acc + r.temps, 0);
        const mitjana = (tempsTotal / respostes.length).toFixed(1);
        const posRanking = ranking.findIndex(r => r.nom === nomJugador && r.punts === puntuacio) + 1;
        
        let emoji, msg, color;
        if (pct >= 90) { emoji = 'üèÜ'; msg = t('EXCEL¬∑LENT!', '¬°EXCELENTE!', 'EXCELLENT!'); color = 'from-yellow-400 to-amber-500'; }
        else if (pct >= 70) { emoji = 'üéâ'; msg = t('MOLT B√â!', '¬°MUY BIEN!', 'VERY GOOD!'); color = 'from-green-400 to-emerald-500'; }
        else if (pct >= 50) { emoji = 'üëç'; msg = t('B√â!', '¬°BIEN!', 'GOOD!'); color = 'from-blue-400 to-cyan-500'; }
        else { emoji = 'üí™'; msg = t('CONTINUA!', '¬°SIGUE!', 'KEEP GOING!'); color = 'from-purple-400 to-pink-500'; }
        
        return (
            <div className="max-w-2xl mx-auto space-y-6 animate-fade">
                <Confetti show={showConfetti} />
                
                <div className={`text-center py-10 bg-gradient-to-r ${color} rounded-3xl relative overflow-hidden`}>
                    <div className="absolute inset-0 bg-white/10"></div>
                    <span className="text-8xl block mb-4 animate-bounce relative z-10">{emoji}</span>
                    <h2 className="text-4xl font-black text-white mb-2 relative z-10">{msg}</h2>
                    <p className="text-xl text-white/80 relative z-10">{nomJugador}</p>
                </div>
                
                <Card>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div className="p-4 bg-yellow-400/20 rounded-xl">
                            <p className="text-4xl font-black text-yellow-400">{puntuacio}</p>
                            <p className="text-sm text-purple-300">{t("Punts", "Puntos", "Points")}</p>
                        </div>
                        <div className="p-4 bg-green-400/20 rounded-xl">
                            <p className="text-4xl font-black text-green-400">{correctes}/{respostes.length}</p>
                            <p className="text-sm text-purple-300">{t("Encerts", "Aciertos", "Correct")}</p>
                        </div>
                        <div className="p-4 bg-blue-400/20 rounded-xl">
                            <p className="text-4xl font-black text-blue-400">{pct}%</p>
                            <p className="text-sm text-purple-300">{t("Precisi√≥", "Precisi√≥n", "Accuracy")}</p>
                        </div>
                        <div className="p-4 bg-orange-400/20 rounded-xl">
                            <p className="text-4xl font-black text-orange-400">üî•{maxRatxa}</p>
                            <p className="text-sm text-purple-300">{t("Max ratxa", "Max racha", "Max streak")}</p>
                        </div>
                    </div>
                    
                    {posRanking > 0 && posRanking <= 10 && (
                        <div className="mt-6 p-5 gold-gradient rounded-xl text-center animate-glow">
                            <span className="text-4xl">üèÜ</span>
                            <p className="font-black text-2xl text-slate-900">{t(`TOP ${posRanking}!`, `¬°TOP ${posRanking}!`, `TOP ${posRanking}!`)}</p>
                        </div>
                    )}
                </Card>
                
                <div className="flex gap-3">
                    <button onClick={() => { setFase('inici'); setPuntuacio(0); setRespostes([]); setMaxRatxa(0); }} className="flex-1 py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95 transition-all">
                        üîÑ {t("Tornar a jugar", "Volver a jugar", "Play again")}
                    </button>
                    <button onClick={() => setFase('ranking')} className="flex-1 py-4 gold-gradient text-slate-900 font-bold rounded-xl hover:opacity-90 active:scale-95 transition-all">
                        üèÜ Ranking
                    </button>
                </div>
            </div>
        );
    };

    // PANTALLA RANKING
    const PantallaRanking = () => (
        <div className="max-w-2xl mx-auto space-y-6 animate-fade">
            <div className="text-center py-8">
                <span className="text-6xl mb-4 block animate-bounce">üèÜ</span>
                <h2 className="text-4xl font-black text-white">TOP 10</h2>
                <p className="text-purple-300">{t("Els millors jugadors", "Los mejores jugadores", "Top players")}</p>
            </div>
            
            <Card>
                {ranking.length === 0 ? (
                    <div className="text-center py-10 text-purple-300">
                        <span className="text-5xl block mb-3">üì≠</span>
                        <p className="text-lg">{t("Encara no hi ha puntuacions", "A√∫n no hay puntuaciones", "No scores yet")}</p>
                        <p className="text-sm mt-1">{t("Sigues el primer!", "¬°S√© el primero!", "Be the first!")}</p>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {ranking.map((entry, i) => (
                            <div key={i} className={`flex items-center gap-4 p-4 rounded-xl transition-all hover:scale-[1.02] ${i === 0 ? 'gold-gradient animate-glow' : i === 1 ? 'bg-slate-300/20' : i === 2 ? 'bg-orange-400/20' : 'bg-white/5'}`}>
                                <div className={`w-12 h-12 rounded-full flex items-center justify-center font-black text-xl ${i === 0 ? 'bg-yellow-600 text-yellow-100' : i === 1 ? 'bg-slate-400 text-slate-100' : i === 2 ? 'bg-orange-600 text-orange-100' : 'bg-white/20 text-white'}`}>
                                    {i === 0 ? 'üëë' : i + 1}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className={`font-bold text-lg truncate ${i === 0 ? 'text-slate-900' : 'text-white'}`}>{entry.nom}</p>
                                    <p className={`text-xs truncate ${i === 0 ? 'text-slate-700' : 'text-purple-300'}`}>
                                        {entry.data} ¬∑ {entry.correctes}/20 ¬∑ üî•{entry.maxRatxa || 0}
                                    </p>
                                </div>
                                <div className="text-right">
                                    <p className={`text-2xl font-black ${i === 0 ? 'text-slate-900' : 'text-yellow-400'}`}>{entry.punts}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </Card>
            
            <button onClick={() => setFase('inici')} className="w-full py-4 bg-white/10 border border-white/30 text-white font-bold rounded-xl hover:bg-white/20 active:scale-95 transition-all">
                ‚Üê {t("Tornar", "Volver", "Back")}
            </button>
        </div>
    );

    return (
        <div className="min-h-screen py-6 px-4">
            <Toast {...toast} />
            <PointsPopup {...pointsPopup} />
            <div className="max-w-4xl mx-auto">
                {fase === 'inici' && <PantallaInici />}
                {fase === 'jugant' && <PantallaJoc />}
                {fase === 'resultats' && <PantallaResultats />}
                {fase === 'ranking' && <PantallaRanking />}
                <footer className="mt-8 text-center text-purple-400/60 text-sm">
                    <p>Concurs PDE ¬∑ profedeeconomia.es ¬∑ 2025</p>
                </footer>
            </div>
        </div>
    );
}

ReactDOM.render(<ConcursApp />, document.getElementById('root'));
    </script>
</body>
</html>
