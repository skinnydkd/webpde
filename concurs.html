<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ† Concurs PDE - Economia, Finances i Empresa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Plus Jakarta Sans', -apple-system, sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-10px); } 40% { transform: translateX(10px); } 60% { transform: translateX(-10px); } 80% { transform: translateX(10px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px #fbbf24; } 50% { box-shadow: 0 0 20px #fbbf24, 0 0 30px #f59e0b; } }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes correctPulse { 0% { background-color: rgba(74, 222, 128, 0.3); } 50% { background-color: rgba(74, 222, 128, 0.6); } 100% { background-color: rgba(74, 222, 128, 0.3); } }
        @keyframes wrongShake { 0%, 100% { transform: translateX(0); background-color: rgba(248, 113, 113, 0.3); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        .animate-pulse-custom { animation: pulse 0.5s ease-in-out; }
        .animate-shake { animation: shake 0.5s ease-in-out; }
        .animate-bounce { animation: bounce 0.5s ease-in-out; }
        .animate-glow { animation: glow 1s ease-in-out infinite; }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .animate-popIn { animation: popIn 0.3s ease-out; }
        .animate-correct { animation: correctPulse 0.5s ease-in-out; }
        .animate-wrong { animation: wrongShake 0.5s ease-in-out; }
        .gold-gradient { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .confetti { position: fixed; width: 10px; height: 10px; top: -10px; animation: confetti 3s linear forwards; pointer-events: none; z-index: 1000; }
        .streak-fire { text-shadow: 0 0 10px #f97316, 0 0 20px #ea580c, 0 0 30px #dc2626; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        /* IMPORTANT: Evitar problemes amb el teclat en mÃ²bil */
        html { height: -webkit-fill-available; }
        body { 
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
        }
        input, textarea, select { font-size: 16px !important; } /* Evita zoom automÃ tic en iOS */
        input:focus { outline: none; }
        
        /* Input flotant fix per mÃ²bil */
        #numeric-input-container {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(30, 27, 75, 0.98), rgba(30, 27, 75, 0.95));
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            z-index: 9999;
            border-top: 2px solid rgba(250, 204, 21, 0.5);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }
        #numeric-input-container.active { display: block; }
        #numeric-input-field {
            width: 100%;
            padding: 16px;
            font-size: 24px !important;
            font-weight: bold;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: white;
            margin-bottom: 12px;
        }
        #numeric-input-field:focus {
            border-color: #facc15;
            background: rgba(255,255,255,0.15);
        }
        #numeric-input-field::placeholder { color: rgba(255,255,255,0.5); }
        #numeric-submit-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
        }
        #numeric-submit-btn:active { transform: scale(0.98); }
        #numeric-submit-btn:disabled { opacity: 0.5; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 min-h-screen">
    <!-- INPUT NUMÃˆRIC FORA DE REACT - NO ES RE-RENDERITZA MAI! -->
    <div id="numeric-input-container">
        <input 
            type="text" 
            id="numeric-input-field" 
            inputmode="decimal" 
            pattern="[0-9.,\-]*"
            placeholder="Resultat numÃ¨ric..."
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
        />
        <button id="numeric-submit-btn" type="button">COMPROVAR</button>
    </div>
    
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useMemo, useRef, useCallback, memo } = React;

// TIMER AMB DOM DIRECTE - NO CAUSA CAP RE-RENDER DEL PARE!
function TimerDirect({ timerKey, onTimeUp, isActive }) {
    const timeRef = useRef(60);
    const intervalRef = useRef(null);
    const barRef = useRef(null);
    const textRef = useRef(null);
    const onTimeUpRef = useRef(onTimeUp);
    
    // Actualitzar la referÃ¨ncia del callback sense causar re-render
    useEffect(() => {
        onTimeUpRef.current = onTimeUp;
    }, [onTimeUp]);
    
    // Reset quan canvia timerKey (nova pregunta)
    useEffect(() => {
        timeRef.current = 60;
        if (textRef.current) {
            textRef.current.textContent = '60s';
            textRef.current.className = 'text-2xl font-black min-w-[50px] text-right text-white';
        }
        if (barRef.current) {
            barRef.current.style.width = '100%';
            barRef.current.className = 'h-full bg-green-500 transition-all duration-1000';
        }
    }, [timerKey]);
    
    // Gestionar interval - actualitza DOM directament
    useEffect(() => {
        if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }
        
        if (!isActive) return;
        
        intervalRef.current = setInterval(() => {
            timeRef.current -= 1;
            const t = timeRef.current;
            
            // ACTUALITZAR DOM DIRECTAMENT - SENSE setState!
            if (textRef.current) {
                textRef.current.textContent = t + 's';
                textRef.current.className = t > 30 
                    ? 'text-2xl font-black min-w-[50px] text-right text-white'
                    : t > 10 
                        ? 'text-2xl font-black min-w-[50px] text-right text-amber-400'
                        : 'text-2xl font-black min-w-[50px] text-right text-red-400 animate-pulse';
            }
            if (barRef.current) {
                barRef.current.style.width = ((t / 60) * 100) + '%';
                barRef.current.className = t > 30 
                    ? 'h-full bg-green-500 transition-all duration-1000'
                    : t > 10 
                        ? 'h-full bg-amber-500 transition-all duration-1000'
                        : 'h-full bg-red-500 transition-all duration-1000';
            }
            
            if (t <= 0) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
                if (onTimeUpRef.current) onTimeUpRef.current();
            }
        }, 1000);
        
        return () => {
            if (intervalRef.current) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
            }
        };
    }, [isActive, timerKey]);
    
    // Exposar funciÃ³ per afegir temps (per l'ajuda +60s)
    useEffect(() => {
        window.addTimerTime = (seconds) => {
            timeRef.current = Math.min(timeRef.current + seconds, 120);
            if (textRef.current) textRef.current.textContent = timeRef.current + 's';
            if (barRef.current) barRef.current.style.width = Math.min((timeRef.current / 60) * 100, 100) + '%';
        };
        return () => { delete window.addTimerTime; };
    }, []);
    
    return (
        <div className="flex items-center gap-3">
            <div className="flex-1 h-2 bg-white/20 rounded-full overflow-hidden">
                <div ref={barRef} className="h-full bg-green-500 transition-all duration-1000" style={{width: '100%'}}></div>
            </div>
            <span ref={textRef} className="text-2xl font-black min-w-[50px] text-right text-white">60s</span>
        </div>
    );
}

// Efecte confetti
const Confetti = ({ show }) => {
    if (!show) return null;
    const colors = ['#f59e0b', '#10b981', '#3b82f6', '#ec4899', '#8b5cf6', '#ef4444'];
    return (
        <>
            {[...Array(50)].map((_, i) => (
                <div key={i} className="confetti" style={{
                    left: `${Math.random() * 100}%`,
                    backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                    animationDelay: `${Math.random() * 2}s`,
                    borderRadius: Math.random() > 0.5 ? '50%' : '0',
                }}></div>
            ))}
        </>
    );
};

// Toast notifications
const Toast = ({ message, type, show }) => {
    if (!show) return null;
    const bg = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    return (
        <div className={`fixed top-4 right-4 ${bg} text-white px-6 py-3 rounded-xl font-bold shadow-lg animate-slideIn z-50`}>
            {message}
        </div>
    );
};

// Component per mostrar punts guanyats/perduts
const PointsPopup = ({ points, show }) => {
    if (!show) return null;
    const isPositive = points > 0;
    return (
        <div className={`fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-black animate-popIn z-50 ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
            {isPositive ? '+' : ''}{points}
        </div>
    );
};

function ConcursApp() {
    const [idioma, setIdioma] = useState('val');
    const [fase, setFase] = useState('inici');
    const [categoria, setCategoria] = useState('totes');
    const [nomJugador, setNomJugador] = useState('');
    const [preguntaActual, setPreguntaActual] = useState(0);
    const [puntuacio, setPuntuacio] = useState(0);
    const [respostes, setRespostes] = useState([]);
    const [ratxa, setRatxa] = useState(0);
    const [maxRatxa, setMaxRatxa] = useState(0);
    const [preguntesPartida, setPreguntesPartida] = useState([]);
    const [respostaUsuari, setRespostaUsuari] = useState(null);
    const [mostrarResultat, setMostrarResultat] = useState(false);
    const [ranking, setRanking] = useState([]);
    const [ordreUsuari, setOrdreUsuari] = useState([]);
    const [timerKey, setTimerKey] = useState(0);
    const [timerActive, setTimerActive] = useState(false);
    const [showConfetti, setShowConfetti] = useState(false);
    const [toast, setToast] = useState({ show: false, message: '', type: '' });
    const [pointsPopup, setPointsPopup] = useState({ show: false, points: 0 });
    const [ajudes, setAjudes] = useState({ cinquanta: 1, temps: 1, saltar: 1 });
    const [opcionsEliminades, setOpcionsEliminades] = useState([]);
    const [soundEnabled, setSoundEnabled] = useState(true);
    
    const t = (val, es, en) => idioma === 'val' ? val : idioma === 'es' ? es : en;
    
    // Efectes de so
    const playSound = useCallback((type) => {
        if (!soundEnabled) return;
        try {
            const sounds = {
                correct: [523.25, 659.25, 783.99], // Do-Mi-Sol
                wrong: [311.13, 293.66], // Miâ™­-Re
                tick: [800],
                bonus: [523.25, 659.25, 783.99, 1046.50], // Do-Mi-Sol-Do'
            };
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const notes = sounds[type] || [440];
            notes.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.1 + 0.3);
                osc.start(ctx.currentTime + i * 0.1);
                osc.stop(ctx.currentTime + i * 0.1 + 0.3);
            });
        } catch(e) {}
    }, [soundEnabled]);
    
    // Vibrar en mÃ²bil
    const vibrate = useCallback((pattern) => {
        if (navigator.vibrate) navigator.vibrate(pattern);
    }, []);
    
    // Toast helper
    const showToast = useCallback((message, type = 'info') => {
        setToast({ show: true, message, type });
        setTimeout(() => setToast({ show: false, message: '', type: '' }), 2000);
    }, []);
    
    // GESTIÃ“ INPUT HTML FLOTANT - Mostrar/amagar segons l'estat
    useEffect(() => {
        const p = preguntesPartida[preguntaActual];
        const esNumeric = p && p.tipus === 'numeric';
        const mostrar = fase === 'jugant' && esNumeric && !mostrarResultat;
        
        const container = document.getElementById('numeric-input-container');
        const input = document.getElementById('numeric-input-field');
        const btn = document.getElementById('numeric-submit-btn');
        
        if (mostrar) {
            if (container) container.classList.add('active');
            if (input) {
                input.value = '';
                input.placeholder = idioma === 'val' ? 'Resultat numÃ¨ric...' : idioma === 'es' ? 'Resultado numÃ©rico...' : 'Numeric result...';
                // Focus amb delay per assegurar estabilitat
                setTimeout(() => {
                    if (input && document.activeElement !== input) {
                        input.focus();
                    }
                }, 100);
            }
            if (btn) {
                btn.textContent = idioma === 'val' ? 'COMPROVAR' : idioma === 'es' ? 'COMPROBAR' : 'CHECK';
            }
        } else {
            if (container) container.classList.remove('active');
            if (input) input.blur();
        }
    }, [fase, preguntaActual, mostrarResultat, preguntesPartida, idioma]);

    // BANC DE PREGUNTES
    const bancPreguntes = useMemo(() => ({
        economia: [
            { id: 'ec1', tipus: 'numeric', dificultat: 'facil', pregunta: t("Elasticitat: Preu puja 10â†’12â‚¬, Demanda baixa 100â†’80u. Elasticitat? (absolut)", "Elasticidad: Precio sube 10â†’12â‚¬, Demanda baja 100â†’80u. Â¿Elasticidad? (absoluto)", "Elasticity: Price rises 10â†’12â‚¬, Demand drops 100â†’80u. Elasticity? (absolute)"), correcta: 1, tolerancia: 0.1, pista: "Ed = (%Î”Q) / (%Î”P)" },
            { id: 'ec2', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("PIB = C+I+G+(X-M). C=500, I=200, G=150, X=100, M=80. PIB?", "PIB = C+I+G+(X-M). C=500, I=200, G=150, X=100, M=80. Â¿PIB?", "GDP = C+I+G+(X-M). C=500, I=200, G=150, X=100, M=80. GDP?"), correcta: 870, tolerancia: 0, pista: "Suma tots els components" },
            { id: 'ec3', tipus: 'numeric', dificultat: 'facil', pregunta: t("Taxa d'atur: 2M aturats, 18M ocupats. Taxa en %?", "Tasa de paro: 2M parados, 18M ocupados. Â¿Tasa en %?", "Unemployment: 2M unemployed, 18M employed. Rate %?"), correcta: 10, tolerancia: 0, pista: "Atur/(Atur+Ocupats)Ã—100" },
            { id: 'ec4', tipus: 'numeric', dificultat: 'dificil', pregunta: t("Multiplicador keynesiÃ  amb PMC=0.8?", "Multiplicador keynesiano con PMC=0.8?", "Keynesian multiplier with MPC=0.8?"), correcta: 5, tolerancia: 0, pista: "1/(1-PMC)" },
            { id: 'ec5', tipus: 'numeric', dificultat: 'facil', pregunta: t("InflaciÃ³: IPC anterior=100, IPC actual=103. InflaciÃ³ %?", "InflaciÃ³n: IPC anterior=100, IPC actual=103. Â¿InflaciÃ³n %?", "Inflation: Previous CPI=100, Current CPI=103. Inflation %?"), correcta: 3, tolerancia: 0, pista: "(IPCnew-IPCold)/IPColdÃ—100" },
            { id: 'ec6', tipus: 'numeric', dificultat: 'dificil', pregunta: t("Creixement real: PIB nominal +7%, inflaciÃ³ 4%. Creixement real aprox?", "Crecimiento real: PIB nominal +7%, inflaciÃ³n 4%. Â¿Crecimiento real aprox?", "Real growth: Nominal GDP +7%, inflation 4%. Approx real growth?"), correcta: 3, tolerancia: 0.5, pista: "Nominal - InflaciÃ³" },
            { id: 'ec7', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("BalanÃ§a comercial: X=50.000Mâ‚¬, M=65.000Mâ‚¬. Saldo?", "Balanza comercial: X=50.000Mâ‚¬, M=65.000Mâ‚¬. Â¿Saldo?", "Trade balance: X=â‚¬50,000M, M=â‚¬65,000M. Balance?"), correcta: -15000, tolerancia: 0, pista: "X - M" },
            { id: 'eo1', tipus: 'order', dificultat: 'mitjana', pregunta: t("Fases del cicle econÃ²mic:", "Fases del ciclo econÃ³mico:", "Business cycle phases:"), elements: [t("ExpansiÃ³", "ExpansiÃ³n", "Expansion"), t("Cim", "Cima", "Peak"), t("RecessiÃ³", "RecesiÃ³n", "Recession"), t("Fons", "Valle", "Trough")], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'eo2', tipus: 'order', dificultat: 'dificil', pregunta: t("Escoles econÃ²miques cronolÃ²gicament:", "Escuelas econÃ³micas cronolÃ³gicamente:", "Economic schools chronologically:"), elements: [t("Mercantilisme", "Mercantilismo", "Mercantilism"), t("FisiocrÃ cia", "Fisiocracia", "Physiocracy"), t("ClÃ ssica", "ClÃ¡sica", "Classical"), t("Keynesiana", "Keynesiana", "Keynesian")], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'eo3', tipus: 'order', dificultat: 'facil', pregunta: t("Sectors econÃ²mics (ordre clÃ ssic):", "Sectores econÃ³micos (orden clÃ¡sico):", "Economic sectors (classic order):"), elements: [t("Primari", "Primario", "Primary"), t("Secundari", "Secundario", "Secondary"), t("Terciari", "Terciario", "Tertiary")], ordreCorrecte: [0, 1, 2] },
            { id: 'ef1', tipus: 'formula', dificultat: 'facil', pregunta: "PIB = C + I + G + ___", opcions: ["(X-M)", "(M-X)", "T", "S"], correcta: 0 },
            { id: 'ef2', tipus: 'formula', dificultat: 'mitjana', pregunta: t("Taxa d'atur = Aturats / ___ Ã— 100", "Tasa de paro = Parados / ___ Ã— 100", "Unemployment = Unemployed / ___ Ã— 100"), opcions: [t("PoblaciÃ³ activa", "PoblaciÃ³n activa", "Labor force"), t("PoblaciÃ³ total", "PoblaciÃ³n total", "Total pop."), t("Ocupats", "Ocupados", "Employed"), "PIB"], correcta: 0 },
            { id: 'ef3', tipus: 'formula', dificultat: 'dificil', pregunta: t("Multiplicador = 1 / (1 - ___)", "Multiplicador = 1 / (1 - ___)", "Multiplier = 1 / (1 - ___)"), opcions: ["PMC", "PMA", "i", "t"], correcta: 0 },
            { id: 'eg1', tipus: 'identify', dificultat: 'facil', pregunta: t("Identifica el grÃ fic d'equilibri de mercat:", "Identifica el grÃ¡fico de equilibrio de mercado:", "Identify market equilibrium graph:"), imatge: "oferta_demanda", opcions: ["Phillips", t("Oferta-Demanda", "Oferta-Demanda", "Supply-Demand"), "IS-LM", "Laffer"], correcta: 1 },
            { id: 'eg2', tipus: 'identify', dificultat: 'mitjana', pregunta: t("Quin model macroeconÃ²mic Ã©s aquest?", "Â¿QuÃ© modelo macroeconÃ³mico es este?", "Which macro model is this?"), imatge: "islm", opcions: ["AD-AS", "IS-LM", t("Flux circular", "Flujo circular", "Circular flow"), "Phillips"], correcta: 1 },
            { id: 'eg3', tipus: 'identify', dificultat: 'dificil', pregunta: t("Corba que relaciona impostos i recaptaciÃ³:", "Curva que relaciona impuestos y recaudaciÃ³n:", "Curve relating taxes and revenue:"), imatge: "laffer", opcions: ["Phillips", "Lorenz", "Laffer", "Engel"], correcta: 2 },
            { id: 'ev1', tipus: 'truefalse', dificultat: 'facil', pregunta: t("La inflaciÃ³ Ã©s la pujada generalitzada i sostinguda dels preus", "La inflaciÃ³n es la subida generalizada y sostenida de los precios", "Inflation is the general sustained rise in prices"), correcta: true },
            { id: 'ev2', tipus: 'truefalse', dificultat: 'mitjana', pregunta: t("La corba de Phillips mostra relaciÃ³ DIRECTA inflaciÃ³-atur", "La curva de Phillips muestra relaciÃ³n DIRECTA inflaciÃ³n-paro", "Phillips curve shows DIRECT inflation-unemployment relation"), correcta: false },
        ],
        finances: [
            { id: 'fc1', tipus: 'numeric', dificultat: 'facil', pregunta: t("Marge brut: Compra 80â‚¬, Venda 120â‚¬. Marge %?", "Margen bruto: Compra 80â‚¬, Venta 120â‚¬. Â¿Margen %?", "Gross margin: Buy â‚¬80, Sell â‚¬120. Margin %?"), correcta: 50, tolerancia: 0, pista: "(V-C)/CÃ—100" },
            { id: 'fc2', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("ROE: Benefici 30.000â‚¬, PN 150.000â‚¬. ROE %?", "ROE: Beneficio 30.000â‚¬, PN 150.000â‚¬. Â¿ROE %?", "ROE: Profit â‚¬30,000, Equity â‚¬150,000. ROE %?"), correcta: 20, tolerancia: 0, pista: "Benefici/PNÃ—100" },
            { id: 'fc3', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("ROA: Benefici 25.000â‚¬, Actiu 500.000â‚¬. ROA %?", "ROA: Beneficio 25.000â‚¬, Activo 500.000â‚¬. Â¿ROA %?", "ROA: Profit â‚¬25,000, Assets â‚¬500,000. ROA %?"), correcta: 5, tolerancia: 0, pista: "Benefici/ActiuÃ—100" },
            { id: 'fc4', tipus: 'numeric', dificultat: 'facil', pregunta: t("Liquiditat: AC=90.000â‚¬, PC=45.000â‚¬. RÃ tio?", "Liquidez: AC=90.000â‚¬, PC=45.000â‚¬. Â¿Ratio?", "Liquidity: CA=â‚¬90,000, CL=â‚¬45,000. Ratio?"), correcta: 2, tolerancia: 0, pista: "AC/PC" },
            { id: 'fc5', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("Endeutament: Passiu=120.000â‚¬, Actiu=200.000â‚¬. RÃ tio %?", "Endeudamiento: Pasivo=120.000â‚¬, Activo=200.000â‚¬. Â¿Ratio %?", "Debt: Liabilities=â‚¬120,000, Assets=â‚¬200,000. Ratio %?"), correcta: 60, tolerancia: 0, pista: "Passiu/ActiuÃ—100" },
            { id: 'fc6', tipus: 'numeric', dificultat: 'dificil', pregunta: t("VAN: Iâ‚€=10.000â‚¬, FCâ‚=6.000â‚¬, FCâ‚‚=6.000â‚¬, k=10%. VAN?", "VAN: Iâ‚€=10.000â‚¬, FCâ‚=6.000â‚¬, FCâ‚‚=6.000â‚¬, k=10%. Â¿VAN?", "NPV: Iâ‚€=â‚¬10,000, CFâ‚=â‚¬6,000, CFâ‚‚=â‚¬6,000, k=10%. NPV?"), correcta: 412, tolerancia: 20, pista: "Î£FC/(1+k)^n - Iâ‚€" },
            { id: 'fc7', tipus: 'numeric', dificultat: 'facil', pregunta: t("Fons Maniobra: AC=80.000â‚¬, PC=50.000â‚¬. FM?", "Fondo Maniobra: AC=80.000â‚¬, PC=50.000â‚¬. Â¿FM?", "Working Capital: CA=â‚¬80,000, CL=â‚¬50,000. WC?"), correcta: 30000, tolerancia: 0, pista: "AC - PC" },
            { id: 'fc8', tipus: 'numeric', dificultat: 'facil', pregunta: t("Payback: InversiÃ³=12.000â‚¬, FC anual=4.000â‚¬. Anys?", "Payback: InversiÃ³n=12.000â‚¬, FC anual=4.000â‚¬. Â¿AÃ±os?", "Payback: Investment=â‚¬12,000, annual CF=â‚¬4,000. Years?"), correcta: 3, tolerancia: 0, pista: "InversiÃ³/FC" },
            { id: 'fc9', tipus: 'numeric', dificultat: 'dificil', pregunta: t("InterÃ¨s compost: 10.000â‚¬ al 5% durant 2 anys. Capital final?", "InterÃ©s compuesto: 10.000â‚¬ al 5% durante 2 aÃ±os. Â¿Capital final?", "Compound: â‚¬10,000 at 5% for 2 years. Final capital?"), correcta: 11025, tolerancia: 5, pista: "CÃ—(1+i)^n" },
            { id: 'fc10', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("Test Ã cid: AC=100.000â‚¬, Exist.=30.000â‚¬, PC=50.000â‚¬. RÃ tio?", "Test Ã¡cido: AC=100.000â‚¬, Exist.=30.000â‚¬, PC=50.000â‚¬. Â¿Ratio?", "Acid test: CA=â‚¬100,000, Inv.=â‚¬30,000, CL=â‚¬50,000. Ratio?"), correcta: 1.4, tolerancia: 0.01, pista: "(AC-ExistÃ¨ncies)/PC" },
            { id: 'ff1', tipus: 'formula', dificultat: 'facil', pregunta: t("Fons Maniobra = AC - ___", "Fondo Maniobra = AC - ___", "Working Capital = CA - ___"), opcions: ["PC", "PN", "ANC", "PNC"], correcta: 0 },
            { id: 'ff2', tipus: 'formula', dificultat: 'mitjana', pregunta: t("ROE = Benefici Net / ___", "ROE = Beneficio Neto / ___", "ROE = Net Profit / ___"), opcions: [t("Patrimoni Net", "Patrimonio Neto", "Equity"), t("Actiu Total", "Activo Total", "Total Assets"), t("Vendes", "Ventas", "Sales"), "Passiu"], correcta: 0 },
            { id: 'ff3', tipus: 'formula', dificultat: 'mitjana', pregunta: "VAN = Î£ FC/(1+k)^n - ___", opcions: ["Iâ‚€", "TIR", "k", "n"], correcta: 0 },
            { id: 'ff4', tipus: 'formula', dificultat: 'dificil', pregunta: t("TIR Ã©s la taxa on VAN = ___", "TIR es la tasa donde VAN = ___", "IRR is rate where NPV = ___"), opcions: ["0", "1", "Iâ‚€", "âˆ"], correcta: 0 },
            { id: 'fi1', tipus: 'identify', dificultat: 'facil', pregunta: t("Document que mostra estructura patrimonial:", "Documento que muestra estructura patrimonial:", "Document showing asset structure:"), imatge: "balanc", opcions: [t("BalanÃ§", "Balance", "Balance Sheet"), t("Compte PiG", "Cuenta PyG", "P&L"), t("Fluxos", "Flujos", "Cash Flow"), "DAFO"], correcta: 0 },
            { id: 'fi2', tipus: 'identify', dificultat: 'mitjana', pregunta: t("LEASING Ã©s finanÃ§ament...", "LEASING es financiaciÃ³n...", "LEASING is financing..."), imatge: "leasing", opcions: [t("Propi", "Propio", "Own"), t("AliÃ¨ llarg termini", "Ajeno largo plazo", "Long-term external"), t("AliÃ¨ curt termini", "Ajeno corto plazo", "Short-term external"), t("AutofinanÃ§ament", "AutofinanciaciÃ³n", "Self-financing")], correcta: 1 },
            { id: 'fi3', tipus: 'identify', dificultat: 'mitjana', pregunta: t("FACTORING serveix per...", "FACTORING sirve para...", "FACTORING is for..."), imatge: "factoring", opcions: [t("Comprar maquinÃ ria", "Comprar maquinaria", "Buy machinery"), t("AvanÃ§ar cobraments", "Adelantar cobros", "Advance collections"), t("Exportacions", "Exportaciones", "Exports"), t("Impostos", "Impuestos", "Taxes")], correcta: 1 },
            { id: 'fv1', tipus: 'truefalse', dificultat: 'facil', pregunta: t("VAN positiu = projecte rendible", "VAN positivo = proyecto rentable", "Positive NPV = profitable project"), correcta: true },
            { id: 'fv2', tipus: 'truefalse', dificultat: 'mitjana', pregunta: t("El Payback simple NO considera el valor temporal dels diners", "El Payback simple NO considera el valor temporal del dinero", "Simple Payback does NOT consider time value of money"), correcta: true },
        ],
        empresa: [
            { id: 'emc1', tipus: 'numeric', dificultat: 'facil', pregunta: t("Punt Mort: CF=15.000â‚¬, P=60â‚¬, CVu=30â‚¬. Unitats?", "Punto Muerto: CF=15.000â‚¬, P=60â‚¬, CVu=30â‚¬. Â¿Unidades?", "Break-even: FC=â‚¬15,000, P=â‚¬60, VCu=â‚¬30. Units?"), correcta: 500, tolerancia: 0, pista: "CF/(P-CVu)" },
            { id: 'emc2', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("Cost Total: CF=8.000â‚¬, CVu=15â‚¬, Q=400. CT?", "Coste Total: CF=8.000â‚¬, CVu=15â‚¬, Q=400. Â¿CT?", "Total Cost: FC=â‚¬8,000, VCu=â‚¬15, Q=400. TC?"), correcta: 14000, tolerancia: 0, pista: "CF + CVuÃ—Q" },
            { id: 'emc3', tipus: 'numeric', dificultat: 'mitjana', pregunta: t("Productivitat: 10.000u, 25 treballadors. Prod/treballador?", "Productividad: 10.000u, 25 trabajadores. Â¿Prod/trabajador?", "Productivity: 10,000u, 25 workers. Prod/worker?"), correcta: 400, tolerancia: 0, pista: "ProducciÃ³/Treballadors" },
            { id: 'emc4', tipus: 'numeric', dificultat: 'facil', pregunta: t("Marge contribuciÃ³: P=100â‚¬, CVu=60â‚¬. MCu?", "Margen contribuciÃ³n: P=100â‚¬, CVu=60â‚¬. Â¿MCu?", "Contribution margin: P=â‚¬100, VCu=â‚¬60. UCM?"), correcta: 40, tolerancia: 0, pista: "P - CVu" },
            { id: 'emc5', tipus: 'numeric', dificultat: 'dificil', pregunta: t("EOQ: D=10.000u/any, Cp=50â‚¬, Ca=2â‚¬/uÂ·any. Lot Ã²ptim?", "EOQ: D=10.000u/aÃ±o, Cp=50â‚¬, Ca=2â‚¬/uÂ·aÃ±o. Â¿Lote Ã³ptimo?", "EOQ: D=10,000u/yr, Cp=â‚¬50, Ca=â‚¬2/uÂ·yr. Optimal lot?"), correcta: 707, tolerancia: 15, pista: "âˆš(2Ã—DÃ—Cp/Ca)" },
            { id: 'emc6', tipus: 'numeric', dificultat: 'facil', pregunta: t("Benefici: Ingressos=200.000â‚¬, Costos=150.000â‚¬. Benefici?", "Beneficio: Ingresos=200.000â‚¬, Costes=150.000â‚¬. Â¿Beneficio?", "Profit: Revenue=â‚¬200,000, Costs=â‚¬150,000. Profit?"), correcta: 50000, tolerancia: 0, pista: "Ingressos - Costos" },
            { id: 'emc7', tipus: 'numeric', dificultat: 'facil', pregunta: t("Salari net: Brut=2.000â‚¬, SS=127â‚¬, IRPF=300â‚¬. Net?", "Salario neto: Bruto=2.000â‚¬, SS=127â‚¬, IRPF=300â‚¬. Â¿Neto?", "Net salary: Gross=â‚¬2,000, SS=â‚¬127, Tax=â‚¬300. Net?"), correcta: 1573, tolerancia: 0, pista: "Brut - SS - IRPF" },
            { id: 'emc8', tipus: 'numeric', dificultat: 'dificil', pregunta: t("Apalancament operatiu: MC=50.000â‚¬, BAII=20.000â‚¬. Grau?", "Apalancamiento operativo: MC=50.000â‚¬, BAII=20.000â‚¬. Â¿Grado?", "Operating leverage: CM=â‚¬50,000, EBIT=â‚¬20,000. Degree?"), correcta: 2.5, tolerancia: 0.1, pista: "MC/BAII" },
            { id: 'emo1', tipus: 'order', dificultat: 'facil', pregunta: t("PirÃ mide Maslow (baixâ†’dalt):", "PirÃ¡mide Maslow (abajoâ†’arriba):", "Maslow pyramid (bottomâ†’top):"), elements: [t("FisiolÃ²giques", "FisiolÃ³gicas", "Physiological"), t("Seguretat", "Seguridad", "Safety"), t("Socials", "Sociales", "Social"), t("Estima", "Estima", "Esteem"), t("AutorealitzaciÃ³", "AutorrealizaciÃ³n", "Self-actualization")], ordreCorrecte: [0, 1, 2, 3, 4] },
            { id: 'emo2', tipus: 'order', dificultat: 'mitjana', pregunta: t("Cicle vida producte:", "Ciclo vida producto:", "Product life cycle:"), elements: [t("IntroducciÃ³", "IntroducciÃ³n", "Introduction"), t("Creixement", "Crecimiento", "Growth"), t("Maduresa", "Madurez", "Maturity"), t("Declivi", "Declive", "Decline")], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'emo3', tipus: 'order', dificultat: 'mitjana', pregunta: t("ProcÃ©s selecciÃ³ personal:", "Proceso selecciÃ³n personal:", "Staff selection process:"), elements: [t("AnÃ lisi lloc", "AnÃ¡lisis puesto", "Job analysis"), t("Reclutament", "Reclutamiento", "Recruitment"), t("Entrevistes", "Entrevistas", "Interviews"), t("ContractaciÃ³", "ContrataciÃ³n", "Hiring")], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'emo4', tipus: 'order', dificultat: 'facil', pregunta: t("Capital mÃ­nim (Espanya) menorâ†’major:", "Capital mÃ­nimo (EspaÃ±a) menorâ†’mayor:", "Min capital (Spain) lowâ†’high:"), elements: [t("AutÃ²nom", "AutÃ³nomo", "Self-empl."), "SL (1â‚¬)", "SL (3.000â‚¬)", "SA (60.000â‚¬)"], ordreCorrecte: [0, 1, 2, 3] },
            { id: 'emi1', tipus: 'identify', dificultat: 'facil', pregunta: t("Identifica la matriu:", "Identifica la matriz:", "Identify the matrix:"), imatge: "bcg", opcions: ["DAFO", "Ansoff", "BCG", "Porter"], correcta: 2 },
            { id: 'emi2', tipus: 'identify', dificultat: 'mitjana', pregunta: t("BCG: Alta quota + Alt creixement =", "BCG: Alta cuota + Alto crecimiento =", "BCG: High share + High growth ="), imatge: "bcg", opcions: [t("Vaca", "Vaca", "Cash Cow"), t("Estrella", "Estrella", "Star"), t("Interrogant", "Interrogante", "Question"), t("Gos", "Perro", "Dog")], correcta: 1 },
            { id: 'emi3', tipus: 'identify', dificultat: 'mitjana', pregunta: t("Ansoff: Producte NOU + Mercat NOU =", "Ansoff: Producto NUEVO + Mercado NUEVO =", "Ansoff: NEW Product + NEW Market ="), imatge: "ansoff", opcions: [t("PenetraciÃ³", "PenetraciÃ³n", "Penetration"), t("Desenv. mercat", "Desarrollo mercado", "Market dev."), t("Desenv. producte", "Desarrollo producto", "Product dev."), t("DiversificaciÃ³", "DiversificaciÃ³n", "Diversification")], correcta: 3 },
            { id: 'emi4', tipus: 'identify', dificultat: 'dificil', pregunta: t("Canvas: 'Per quÃ¨ ens trien' =", "Canvas: 'Por quÃ© nos eligen' =", "Canvas: 'Why they choose us' ="), imatge: "canvas", opcions: [t("Segments", "Segmentos", "Segments"), t("Proposta valor", "Propuesta valor", "Value prop."), t("Canals", "Canales", "Channels"), t("Recursos", "Recursos", "Resources")], correcta: 1 },
            { id: 'emi5', tipus: 'identify', dificultat: 'facil', pregunta: t("DAFO: Amenaces sÃ³n factors...", "DAFO: Amenazas son factores...", "SWOT: Threats are factors..."), imatge: "dafo", opcions: [t("Interns +", "Internos +", "Internal +"), t("Interns -", "Internos -", "Internal -"), t("Externs +", "Externos +", "External +"), t("Externs -", "Externos -", "External -")], correcta: 3 },
            { id: 'emi6', tipus: 'identify', dificultat: 'mitjana', pregunta: t("Porter: Quantes forces?", "Porter: Â¿CuÃ¡ntas fuerzas?", "Porter: How many forces?"), imatge: "porter", opcions: ["3", "4", "5", "6"], correcta: 2 },
            { id: 'emf1', tipus: 'formula', dificultat: 'facil', pregunta: t("Punt Mort = CF / (P - ___)", "Punto Muerto = CF / (P - ___)", "Break-even = FC / (P - ___)"), opcions: ["CVu", "CT", "CF", "MC"], correcta: 0 },
            { id: 'emf2', tipus: 'formula', dificultat: 'mitjana', pregunta: t("Productivitat = ___ / Recursos", "Productividad = ___ / Recursos", "Productivity = ___ / Resources"), opcions: [t("ProducciÃ³", "ProducciÃ³n", "Output"), t("Benefici", "Beneficio", "Profit"), t("Vendes", "Ventas", "Sales"), t("Costos", "Costes", "Costs")], correcta: 0 },
            { id: 'emf3', tipus: 'formula', dificultat: 'mitjana', pregunta: t("Cost Total = CF + CVu Ã— ___", "Coste Total = CF + CVu Ã— ___", "Total Cost = FC + VCu Ã— ___"), opcions: ["Q", "P", "MC", "CT"], correcta: 0 },
            { id: 'emf4', tipus: 'formula', dificultat: 'dificil', pregunta: "EOQ = âˆš(2Ã—DÃ—Cp / ___)", opcions: ["Ca", "Cv", "CF", "P"], correcta: 0 },
            { id: 'emv1', tipus: 'truefalse', dificultat: 'facil', pregunta: t("SL: responsabilitat limitada al capital aportat", "SL: responsabilidad limitada al capital aportado", "LLC: liability limited to contributed capital"), correcta: true },
            { id: 'emv2', tipus: 'truefalse', dificultat: 'mitjana', pregunta: t("Herzberg: el salari Ã©s factor MOTIVADOR", "Herzberg: el salario es factor MOTIVADOR", "Herzberg: salary is a MOTIVATING factor"), correcta: false },
        ]
    }), [idioma]);

    useEffect(() => {
        const saved = localStorage.getItem('pde_concurs_ranking_v3');
        if (saved) setRanking(JSON.parse(saved));
    }, []);

    useEffect(() => {
        if (fase === 'jugant' && preguntesPartida[preguntaActual]?.tipus === 'order') {
            const elements = preguntesPartida[preguntaActual].elements;
            setOrdreUsuari(elements.map((_, i) => i).sort(() => Math.random() - 0.5));
        }
    }, [preguntaActual, fase, preguntesPartida]);
    
    const obtenirPreguntes = (cat) => {
        let pool = cat === 'totes' 
            ? [...bancPreguntes.economia, ...bancPreguntes.finances, ...bancPreguntes.empresa]
            : [...bancPreguntes[cat]];
        return pool.sort(() => Math.random() - 0.5).slice(0, 20);
    };

    const iniciarPartida = () => {
        if (!nomJugador.trim()) { showToast(t("Introdueix el teu nom!", "Â¡Introduce tu nombre!", "Enter your name!"), 'error'); return; }
        setPreguntesPartida(obtenirPreguntes(categoria));
        setPreguntaActual(0); setPuntuacio(0); setRespostes([]); setRatxa(0); setMaxRatxa(0);
        setRespostaUsuari(null); setMostrarResultat(false);
        setOrdreUsuari([]); setTimerKey(k => k + 1); setTimerActive(true);
        setAjudes({ cinquanta: 1, temps: 1, saltar: 1 }); setOpcionsEliminades([]);
        setFase('jugant');
        playSound('bonus');
    };

    const calcularPunts = (correcta, tempsUsed, dificultat, ratxaActual) => {
        if (!correcta) return -25;
        let base = dificultat === 'facil' ? 100 : dificultat === 'mitjana' ? 150 : 200;
        const tempsRestant = 60 - tempsUsed;
        const bonusVelocitat = tempsRestant > 40 ? Math.floor((tempsRestant - 40) * 3) : 0;
        let mult = ratxaActual >= 7 ? 3 : ratxaActual >= 5 ? 2.5 : ratxaActual >= 3 ? 2 : ratxaActual >= 1 ? 1.5 : 1;
        return Math.floor((base + bonusVelocitat) * mult);
    };

    const handleResposta = useCallback((resposta) => {
        setTimerActive(false);
        const p = preguntesPartida[preguntaActual];
        let ok = false;
        if (p.tipus === 'multiple' || p.tipus === 'identify' || p.tipus === 'formula') ok = resposta === p.correcta;
        else if (p.tipus === 'truefalse') ok = resposta === p.correcta;
        else if (p.tipus === 'numeric') ok = Math.abs(parseFloat(resposta) - p.correcta) <= (p.tolerancia || 0);
        else if (p.tipus === 'order') ok = JSON.stringify(ordreUsuari) === JSON.stringify(p.ordreCorrecte);
        
        const tempsUsed = 60 - (document.querySelector('.timer-display')?.textContent?.replace('s','') || 30);
        const novaRatxa = ok ? ratxa + 1 : 0;
        const punts = calcularPunts(ok, tempsUsed, p.dificultat, ratxa);
        
        if (ok) {
            playSound('correct');
            vibrate([100]);
            if (novaRatxa >= 3) showToast(`ğŸ”¥ ${t('Ratxa', 'Racha', 'Streak')} x${novaRatxa}!`, 'success');
        } else {
            playSound('wrong');
            vibrate([100, 50, 100]);
        }
        
        setPointsPopup({ show: true, points: punts });
        setTimeout(() => setPointsPopup({ show: false, points: 0 }), 1000);
        
        setRespostaUsuari(resposta); setMostrarResultat(true); setRatxa(novaRatxa);
        if (novaRatxa > maxRatxa) setMaxRatxa(novaRatxa);
        setPuntuacio(s => Math.max(0, s + punts));
        setRespostes(r => [...r, { pregunta: p.id, correcta: ok, punts, temps: tempsUsed }]);
    }, [preguntesPartida, preguntaActual, ordreUsuari, ratxa, maxRatxa, playSound, vibrate, showToast, t]);
    
    // EXPOSAR handleResposta GLOBALMENT per l'input HTML flotant
    useEffect(() => {
        window.submitNumericAnswer = (value) => {
            if (fase === 'jugant' && !mostrarResultat) {
                handleResposta(value);
            }
        };
        return () => { delete window.submitNumericAnswer; };
    }, [fase, mostrarResultat, handleResposta]);
    
    // SETUP EVENT LISTENERS per l'input flotant (una sola vegada)
    useEffect(() => {
        const input = document.getElementById('numeric-input-field');
        const btn = document.getElementById('numeric-submit-btn');
        
        const handleSubmit = () => {
            const value = input?.value?.trim();
            if (value && window.submitNumericAnswer) {
                window.submitNumericAnswer(value);
            }
        };
        
        const handleKeyDown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSubmit();
            }
        };
        
        if (btn) btn.addEventListener('click', handleSubmit);
        if (input) input.addEventListener('keydown', handleKeyDown);
        
        return () => {
            if (btn) btn.removeEventListener('click', handleSubmit);
            if (input) input.removeEventListener('keydown', handleKeyDown);
        };
    }, []);

    const handleTimeUp = useCallback(() => {
        if (!mostrarResultat) handleResposta(null);
    }, [mostrarResultat, handleResposta]);

    const seguentPregunta = () => {
        setOpcionsEliminades([]);
        if (preguntaActual + 1 >= preguntesPartida.length) {
            const entry = { nom: nomJugador, punts: puntuacio, data: new Date().toLocaleDateString('ca-ES'), correctes: respostes.filter(r => r.correcta).length, categoria, maxRatxa };
            const nouRanking = [...ranking, entry].sort((a, b) => b.punts - a.punts).slice(0, 10);
            setRanking(nouRanking);
            localStorage.setItem('pde_concurs_ranking_v3', JSON.stringify(nouRanking));
            setShowConfetti(true);
            setTimeout(() => setShowConfetti(false), 4000);
            playSound('bonus');
            setFase('resultats');
        } else {
            setPreguntaActual(p => p + 1);
            setRespostaUsuari(null); setMostrarResultat(false);
            setOrdreUsuari([]);
            setTimerKey(k => k + 1); setTimerActive(true);
        }
    };

    // AJUDES
    const usarAjuda50 = () => {
        if (ajudes.cinquanta <= 0 || mostrarResultat) return;
        const p = preguntesPartida[preguntaActual];
        if (p.tipus !== 'multiple' && p.tipus !== 'identify' && p.tipus !== 'formula') {
            showToast(t("NomÃ©s per preguntes tipus test!", "Â¡Solo para preguntas tipo test!", "Only for multiple choice!"), 'error');
            return;
        }
        const incorrectes = p.opcions.map((_, i) => i).filter(i => i !== p.correcta);
        const aEliminar = incorrectes.sort(() => Math.random() - 0.5).slice(0, 2);
        setOpcionsEliminades(aEliminar);
        setAjudes(a => ({ ...a, cinquanta: a.cinquanta - 1 }));
        showToast(t("50:50 activat!", "Â¡50:50 activado!", "50:50 activated!"), 'success');
        playSound('tick');
    };
    
    const usarAjudaTemps = () => {
        if (ajudes.temps <= 0 || mostrarResultat) return;
        // Afegir 60 segons al temps actual via DOM directe
        if (window.addTimerTime) window.addTimerTime(60);
        setAjudes(a => ({ ...a, temps: a.temps - 1 }));
        showToast(t("+60 segons!", "Â¡+60 segundos!", "+60 seconds!"), 'success');
        playSound('bonus');
    };
    
    const usarAjudaSaltar = () => {
        if (ajudes.saltar <= 0 || mostrarResultat) return;
        setAjudes(a => ({ ...a, saltar: a.saltar - 1 }));
        showToast(t("Pregunta saltada!", "Â¡Pregunta saltada!", "Question skipped!"), 'info');
        seguentPregunta();
    };

    const moureElement = (index, dir) => {
        const nou = [...ordreUsuari];
        const newIdx = index + dir;
        if (newIdx < 0 || newIdx >= nou.length) return;
        [nou[index], nou[newIdx]] = [nou[newIdx], nou[index]];
        setOrdreUsuari(nou);
        playSound('tick');
    };

    const Card = ({ children, className = "" }) => (
        <div className={`bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 ${className}`}>{children}</div>
    );

    const renderGrafic = (tipus) => {
        const grafics = {
            bcg: (<div className="grid grid-cols-2 gap-2 w-52 mx-auto my-4 text-xs"><div className="p-3 bg-yellow-400/30 rounded-lg text-center border border-yellow-400/50 animate-pulse">â­ Stars</div><div className="p-3 bg-purple-400/30 rounded-lg text-center border border-purple-400/50">â“ ?</div><div className="p-3 bg-green-400/30 rounded-lg text-center border border-green-400/50">ğŸ„ Cash Cows</div><div className="p-3 bg-slate-400/30 rounded-lg text-center border border-slate-400/50">ğŸ• Dogs</div><div className="col-span-2 text-center text-purple-300 text-[10px] mt-1">â† {t("Quota", "Cuota", "Share")} â†’</div></div>),
            ansoff: (<div className="w-56 mx-auto my-4 text-xs"><div className="grid grid-cols-3 gap-1"><div></div><div className="text-center text-purple-300 text-[10px]">{t("Prod. actual", "Prod. actual", "Current prod.")}</div><div className="text-center text-purple-300 text-[10px]">{t("Prod. nou", "Prod. nuevo", "New prod.")}</div><div className="text-purple-300 text-[10px]">{t("Mercat actual", "Mercado actual", "Current mkt")}</div><div className="p-2 bg-green-400/30 rounded border border-green-400/50 text-center">{t("Penetr.", "Penetr.", "Penetr.")}</div><div className="p-2 bg-amber-400/30 rounded border border-amber-400/50 text-center">{t("Des.Prod", "Des.Prod", "Prod.Dev")}</div><div className="text-purple-300 text-[10px]">{t("Mercat nou", "Mercado nuevo", "New mkt")}</div><div className="p-2 bg-blue-400/30 rounded border border-blue-400/50 text-center">{t("Des.Mkt", "Des.Mkt", "Mkt.Dev")}</div><div className="p-2 bg-red-400/30 rounded border border-red-400/50 text-center animate-pulse">{t("Divers.", "Divers.", "Divers.")}</div></div></div>),
            canvas: (<div className="grid grid-cols-5 gap-1 w-72 mx-auto my-4 text-[10px]"><div className="row-span-2 p-2 bg-violet-400/30 rounded border border-violet-400/50 text-center">ğŸ¤</div><div className="p-2 bg-blue-400/30 rounded border border-blue-400/50 text-center">âš™ï¸</div><div className="row-span-2 p-2 bg-pink-400/30 rounded border border-pink-400/50 text-center animate-pulse">ğŸ’</div><div className="p-2 bg-green-400/30 rounded border border-green-400/50 text-center">â¤ï¸</div><div className="row-span-2 p-2 bg-emerald-400/30 rounded border border-emerald-400/50 text-center">ğŸ‘¥</div><div className="p-2 bg-cyan-400/30 rounded border border-cyan-400/50 text-center">ğŸ—ï¸</div><div className="p-2 bg-amber-400/30 rounded border border-amber-400/50 text-center">ğŸ“¢</div><div className="col-span-2 p-2 bg-red-400/30 rounded border border-red-400/50 text-center">ğŸ’¸</div><div className="col-span-3 p-2 bg-green-400/30 rounded border border-green-400/50 text-center">ğŸ’°</div></div>),
            dafo: (<div className="grid grid-cols-2 gap-2 w-56 mx-auto my-4 text-xs"><div className="p-2 bg-green-400/30 rounded border border-green-400/50 text-center">ğŸ’ª {t("F", "F", "S")}</div><div className="p-2 bg-red-400/30 rounded border border-red-400/50 text-center">ğŸ˜° {t("D", "D", "W")}</div><div className="p-2 bg-blue-400/30 rounded border border-blue-400/50 text-center">ğŸ¯ {t("O", "O", "O")}</div><div className="p-2 bg-orange-400/30 rounded border border-orange-400/50 text-center animate-pulse">âš ï¸ {t("A", "A", "T")}</div></div>),
            porter: (<div className="w-56 mx-auto my-4 text-[10px] text-center"><div className="p-2 bg-red-400/30 rounded border border-red-400/50 mb-1">â¬†ï¸ {t("Entrants", "Entrantes", "Entrants")}</div><div className="flex gap-1"><div className="p-2 bg-blue-400/30 rounded border border-blue-400/50 flex-1">â¬…ï¸</div><div className="p-2 bg-purple-400/30 rounded border border-purple-400/50 flex-1">âš”ï¸</div><div className="p-2 bg-green-400/30 rounded border border-green-400/50 flex-1">â¡ï¸</div></div><div className="p-2 bg-amber-400/30 rounded border border-amber-400/50 mt-1">â¬‡ï¸ {t("Substituts", "Sustitutos", "Substitutes")}</div></div>),
            oferta_demanda: (<div className="w-48 h-32 mx-auto my-4 relative bg-white/5 rounded-lg border border-white/20"><div className="absolute bottom-4 left-4 w-32 h-20 border-l-2 border-b-2 border-purple-400"></div><div className="absolute bottom-6 left-6 w-24 h-1 bg-blue-400 transform -rotate-45 origin-left"></div><div className="absolute bottom-6 left-6 w-24 h-1 bg-red-400 transform rotate-45 origin-left"></div><div className="absolute bottom-2 right-4 text-[10px] text-purple-300">Q</div><div className="absolute top-2 left-2 text-[10px] text-purple-300">P</div><div className="absolute top-1/2 left-1/2 w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div></div>),
            islm: (<div className="w-48 h-32 mx-auto my-4 relative bg-white/5 rounded-lg border border-white/20"><div className="absolute bottom-4 left-4 w-32 h-20 border-l-2 border-b-2 border-purple-400"></div><div className="absolute bottom-8 left-8 w-20 h-1 bg-blue-400" style={{transform:'rotate(-25deg)'}}></div><div className="absolute bottom-16 left-10 w-20 h-1 bg-green-400" style={{transform:'rotate(25deg)'}}></div><div className="absolute top-4 left-10 text-[10px] text-blue-300 font-bold">IS</div><div className="absolute top-8 right-8 text-[10px] text-green-300 font-bold">LM</div></div>),
            laffer: (<div className="w-48 h-32 mx-auto my-4 relative bg-white/5 rounded-lg border border-white/20"><div className="absolute bottom-4 left-4 w-32 h-20 border-l-2 border-b-2 border-purple-400"></div><svg className="absolute bottom-6 left-6 w-28 h-16" viewBox="0 0 100 60"><path d="M 0 60 Q 50 -20 100 60" stroke="#f59e0b" strokeWidth="3" fill="none"/><circle cx="50" cy="10" r="4" fill="#fbbf24" className="animate-pulse"/></svg></div>),
            balanc: (<div className="w-56 mx-auto my-4 text-[10px]"><div className="flex gap-1"><div className="flex-1 p-2 bg-blue-400/30 rounded-t border border-blue-400/50 text-center font-bold">{t("ACTIU", "ACTIVO", "ASSETS")}</div><div className="flex-1 p-2 bg-green-400/30 rounded-t border border-green-400/50 text-center font-bold">{t("P+PN", "P+PN", "L+E")}</div></div><div className="flex gap-1"><div className="flex-1 p-1 bg-blue-400/20 border-x border-blue-400/50">ANC</div><div className="flex-1 p-1 bg-green-400/20 border-x border-green-400/50">PN</div></div><div className="flex gap-1"><div className="flex-1 p-1 bg-blue-400/20 border border-blue-400/50 rounded-b">AC</div><div className="flex-1"><div className="p-1 bg-green-400/20 border-x border-green-400/50">PNC</div><div className="p-1 bg-green-400/20 border border-green-400/50 rounded-b">PC</div></div></div></div>),
            leasing: (<div className="w-48 mx-auto my-4 p-4 bg-blue-400/20 rounded-xl border border-blue-400/50 text-center"><span className="text-3xl">ğŸ¦â¡ï¸ğŸ“¦</span><p className="text-sm mt-2 text-blue-200 font-bold">LEASING</p></div>),
            factoring: (<div className="w-48 mx-auto my-4 p-4 bg-green-400/20 rounded-xl border border-green-400/50 text-center"><span className="text-3xl">ğŸ“„â¡ï¸ğŸ’µ</span><p className="text-sm mt-2 text-green-200 font-bold">FACTORING</p></div>),
        };
        return grafics[tipus] || null;
    };

    // PANTALLA INICI
    const PantallaInici = () => (
        <div className="max-w-2xl mx-auto space-y-6 animate-fade">
            <div className="text-center py-8">
                <span className="text-7xl mb-6 block animate-bounce">ğŸ†</span>
                <h1 className="text-5xl font-black text-white mb-3">{t("Concurs PDE", "Concurso PDE", "PDE Contest")}</h1>
                <p className="text-xl text-purple-200">{t("Economia Â· Finances Â· Empresa", "EconomÃ­a Â· Finanzas Â· Empresa", "Economics Â· Finance Â· Business")}</p>
            </div>
            
            <Card>
                <div className="space-y-5">
                    <div>
                        <label className="block text-sm font-semibold text-purple-200 mb-2">{t("El teu nom", "Tu nombre", "Your name")}</label>
                        <input type="text" value={nomJugador} onChange={e => setNomJugador(e.target.value)} placeholder={t("Escriu el teu nom...", "Escribe tu nombre...", "Enter your name...")} className="w-full p-4 bg-white/10 border border-white/30 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 outline-none text-lg" maxLength={20} />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-semibold text-purple-200 mb-3">{t("Categoria", "CategorÃ­a", "Category")}</label>
                        <div className="grid grid-cols-2 gap-3">
                            {[
                                { id: 'economia', icon: 'ğŸ“ˆ', label: t('Economia', 'EconomÃ­a', 'Economics'), color: 'from-blue-500 to-cyan-500' },
                                { id: 'finances', icon: 'ğŸ’°', label: t('Finances', 'Finanzas', 'Finance'), color: 'from-green-500 to-emerald-500' },
                                { id: 'empresa', icon: 'ğŸ¢', label: t('Empresa', 'Empresa', 'Business'), color: 'from-orange-500 to-red-500' },
                                { id: 'totes', icon: 'ğŸ¯', label: t('Totes', 'Todas', 'All'), color: 'from-purple-500 to-pink-500' },
                            ].map(cat => (
                                <button key={cat.id} onClick={() => { setCategoria(cat.id); playSound('tick'); }} className={`p-4 rounded-xl border-2 transition-all transform hover:scale-105 ${categoria === cat.id ? 'border-yellow-400 bg-gradient-to-r ' + cat.color + ' shadow-lg shadow-yellow-400/30 animate-glow' : 'border-white/30 bg-white/5 hover:bg-white/10'}`}>
                                    <span className="text-3xl block mb-2">{cat.icon}</span>
                                    <span className="font-bold text-white">{cat.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <button onClick={iniciarPartida} className="w-full py-5 gold-gradient text-slate-900 font-black text-xl rounded-xl hover:opacity-90 transition-all shadow-lg shadow-yellow-500/30 transform hover:scale-[1.02] animate-glow">
                        ğŸš€ {t("COMENÃ‡AR!", "Â¡EMPEZAR!", "START!")}
                    </button>
                </div>
            </Card>
            
            <Card>
                <p className="text-sm text-purple-300 mb-3 text-center font-semibold">{t("Ajudes disponibles:", "Ayudas disponibles:", "Available helps:")}</p>
                <div className="grid grid-cols-3 gap-3 text-center">
                    <div className="p-3 bg-blue-500/20 rounded-xl border border-blue-400/50"><span className="text-2xl block mb-1">5ï¸âƒ£0ï¸âƒ£</span><span className="text-xs text-blue-300">50:50</span></div>
                    <div className="p-3 bg-green-500/20 rounded-xl border border-green-400/50"><span className="text-2xl block mb-1">â±ï¸</span><span className="text-xs text-green-300">+60s</span></div>
                    <div className="p-3 bg-amber-500/20 rounded-xl border border-amber-400/50"><span className="text-2xl block mb-1">â­ï¸</span><span className="text-xs text-amber-300">{t("Saltar", "Saltar", "Skip")}</span></div>
                </div>
            </Card>
            
            <div className="flex gap-3">
                <button onClick={() => setFase('ranking')} className="flex-1 py-4 bg-white/10 border border-white/30 text-white font-bold rounded-xl hover:bg-white/20 transition-all">ğŸ† Ranking</button>
                <a href="./index.html" className="flex-1 py-4 bg-white/10 border border-white/30 text-white font-bold rounded-xl hover:bg-white/20 text-center transition-all">ğŸ  {t("Inici", "Inicio", "Home")}</a>
            </div>
            
            <div className="flex justify-center items-center gap-4">
                <div className="flex gap-2">
                    {['val', 'es', 'en'].map(lang => (
                        <button key={lang} onClick={() => setIdioma(lang)} className={`px-4 py-2 rounded-lg font-bold transition-all ${idioma === lang ? 'bg-yellow-400 text-slate-900' : 'bg-white/10 text-white hover:bg-white/20'}`}>{lang.toUpperCase()}</button>
                    ))}
                </div>
                <button onClick={() => setSoundEnabled(!soundEnabled)} className={`p-2 rounded-lg ${soundEnabled ? 'bg-green-500/30 text-green-300' : 'bg-red-500/30 text-red-300'}`}>
                    {soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}
                </button>
            </div>
        </div>
    );

    // PANTALLA JOC
    const PantallaJoc = () => {
        const p = preguntesPartida[preguntaActual];
        if (!p) return null;
        const progressPct = ((preguntaActual + 1) / preguntesPartida.length) * 100;
        const tipusIcons = { numeric: 'ğŸ§®', order: 'ğŸ”¢', formula: 'ğŸ“', identify: 'ğŸ“Š', truefalse: 'âœ“âœ—', multiple: 'ğŸ”˜' };
        
        return (
            <div className="max-w-3xl mx-auto space-y-4 animate-fade">
                {/* Header */}
                <div className="flex items-center justify-between bg-white/10 backdrop-blur rounded-xl p-3 border border-white/20">
                    <div className="flex items-center gap-2">
                        <span className="font-bold text-white bg-white/20 px-3 py-1 rounded-lg">{preguntaActual + 1}/{preguntesPartida.length}</span>
                        <div className="flex items-center gap-1 bg-yellow-400/20 text-yellow-400 px-3 py-1 rounded-lg">
                            <span>ğŸ†</span><span className="font-bold">{puntuacio}</span>
                        </div>
                        {ratxa >= 1 && (
                            <div className={`flex items-center gap-1 px-3 py-1 rounded-lg ${ratxa >= 5 ? 'bg-red-500/30 text-red-400 streak-fire' : ratxa >= 3 ? 'bg-orange-400/30 text-orange-400' : 'bg-amber-400/20 text-amber-400'}`}>
                                <span>{ratxa >= 5 ? 'ğŸ”¥ğŸ”¥' : ratxa >= 3 ? 'ğŸ”¥' : 'âœ¨'}</span>
                                <span className="font-bold">x{ratxa >= 7 ? '3' : ratxa >= 5 ? '2.5' : ratxa >= 3 ? '2' : '1.5'}</span>
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Timer i ProgrÃ©s */}
                <div className="space-y-2">
                    <div className="h-2 bg-white/20 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300" style={{ width: `${progressPct}%` }}></div>
                    </div>
                    <TimerDirect timerKey={timerKey} onTimeUp={handleTimeUp} isActive={timerActive && !mostrarResultat} />
                </div>
                
                {/* Ajudes */}
                {!mostrarResultat && (
                    <div className="flex justify-center gap-2">
                        <button onClick={usarAjuda50} disabled={ajudes.cinquanta <= 0} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${ajudes.cinquanta > 0 ? 'bg-blue-500/30 text-blue-300 hover:bg-blue-500/50' : 'bg-white/10 text-white/30 cursor-not-allowed'}`}>
                            5ï¸âƒ£0ï¸âƒ£ ({ajudes.cinquanta})
                        </button>
                        <button onClick={usarAjudaTemps} disabled={ajudes.temps <= 0} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${ajudes.temps > 0 ? 'bg-green-500/30 text-green-300 hover:bg-green-500/50' : 'bg-white/10 text-white/30 cursor-not-allowed'}`}>
                            â±ï¸ +60s ({ajudes.temps})
                        </button>
                        <button onClick={usarAjudaSaltar} disabled={ajudes.saltar <= 0} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${ajudes.saltar > 0 ? 'bg-amber-500/30 text-amber-300 hover:bg-amber-500/50' : 'bg-white/10 text-white/30 cursor-not-allowed'}`}>
                            â­ï¸ ({ajudes.saltar})
                        </button>
                    </div>
                )}
                
                {/* Pregunta */}
                <Card className={mostrarResultat ? (respostes[respostes.length - 1]?.correcta ? 'animate-correct' : 'animate-wrong') : ''}>
                    <div className="flex items-center gap-2 mb-4">
                        <span className={`px-3 py-1 rounded-lg text-xs font-bold ${p.dificultat === 'facil' ? 'bg-green-400/30 text-green-300' : p.dificultat === 'mitjana' ? 'bg-amber-400/30 text-amber-300' : 'bg-red-400/30 text-red-300'}`}>
                            {p.dificultat === 'facil' ? 'â­' : p.dificultat === 'mitjana' ? 'â­â­' : 'â­â­â­'}
                        </span>
                        <span className="text-lg">{tipusIcons[p.tipus]}</span>
                    </div>
                    
                    <h3 className="text-xl md:text-2xl font-bold text-white mb-6">{p.pregunta}</h3>
                    
                    {p.imatge && renderGrafic(p.imatge)}
                    
                    {/* Opcions mÃºltiples/identify/formula */}
                    {(p.tipus === 'multiple' || p.tipus === 'identify' || p.tipus === 'formula') && (
                        <div className="grid gap-3">
                            {p.opcions.map((op, i) => {
                                if (opcionsEliminades.includes(i)) return (
                                    <div key={i} className="p-4 rounded-xl border-2 border-white/10 bg-white/5 opacity-30 line-through text-white/50">{op}</div>
                                );
                                return (
                                    <button key={i} onClick={() => !mostrarResultat && handleResposta(i)} disabled={mostrarResultat}
                                        className={`p-4 text-left rounded-xl border-2 transition-all font-medium text-white ${
                                            mostrarResultat ? i === p.correcta ? 'border-green-400 bg-green-400/30' : respostaUsuari === i ? 'border-red-400 bg-red-400/30' : 'border-white/20 opacity-40'
                                            : 'border-white/30 hover:border-yellow-400 hover:bg-white/10 cursor-pointer active:scale-95'
                                        }`}>
                                        <span className="font-bold mr-3 text-purple-300">{String.fromCharCode(65 + i)}.</span>{op}
                                        {mostrarResultat && i === p.correcta && <span className="float-right text-green-400 text-xl">âœ“</span>}
                                        {mostrarResultat && respostaUsuari === i && i !== p.correcta && <span className="float-right text-red-400 text-xl">âœ—</span>}
                                    </button>
                                );
                            })}
                        </div>
                    )}
                    
                    {/* Vertader/Fals */}
                    {p.tipus === 'truefalse' && (
                        <div className="grid grid-cols-2 gap-4">
                            {[true, false].map(val => (
                                <button key={String(val)} onClick={() => !mostrarResultat && handleResposta(val)} disabled={mostrarResultat}
                                    className={`p-6 rounded-xl border-2 transition-all font-bold text-xl text-white active:scale-95 ${
                                        mostrarResultat ? val === p.correcta ? 'border-green-400 bg-green-400/30' : respostaUsuari === val ? 'border-red-400 bg-red-400/30' : 'border-white/20 opacity-40'
                                        : 'border-white/30 hover:border-yellow-400 hover:bg-white/10 cursor-pointer'
                                    }`}>
                                    {val ? 'âœ“ ' + t('VERTADER', 'VERDADERO', 'TRUE') : 'âœ— ' + t('FALS', 'FALSO', 'FALSE')}
                                </button>
                            ))}
                        </div>
                    )}
                    
                    {/* NumÃ¨ric - L'input real estÃ  fixat a baix de la pantalla */}
                    {p.tipus === 'numeric' && (
                        <div className="space-y-4">
                            {!mostrarResultat ? (
                                <div className="text-center py-8 text-purple-300">
                                    <span className="text-4xl block mb-3">â¬‡ï¸</span>
                                    <p className="text-lg">{t("Escriu la resposta a baix", "Escribe la respuesta abajo", "Type your answer below")}</p>
                                </div>
                            ) : (
                                <div className="text-center py-4">
                                    <p className="text-lg text-white">{t("Resposta:", "Respuesta:", "Answer:")} <strong className="text-green-400 text-2xl">{p.correcta}</strong></p>
                                    {p.pista && <p className="text-sm text-purple-300 mt-2">ğŸ’¡ {p.pista}</p>}
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Ordenar */}
                    {p.tipus === 'order' && (
                        <div className="space-y-4">
                            <div className="space-y-2">
                                {ordreUsuari.map((elemIdx, pos) => (
                                    <div key={pos} className={`flex items-center gap-3 p-4 rounded-xl border-2 transition-all ${mostrarResultat ? pos === p.ordreCorrecte.indexOf(elemIdx) ? 'border-green-400 bg-green-400/20' : 'border-red-400 bg-red-400/20' : 'border-white/30 bg-white/5'}`}>
                                        <span className="font-bold text-purple-300 w-8 text-lg">{pos + 1}.</span>
                                        <span className="flex-1 font-medium text-white">{p.elements[elemIdx]}</span>
                                        {!mostrarResultat && (
                                            <div className="flex gap-2">
                                                <button onClick={() => moureElement(pos, -1)} disabled={pos === 0} className="w-12 h-12 rounded-lg bg-white/20 hover:bg-white/30 disabled:opacity-30 text-white font-bold text-xl active:scale-90">â–²</button>
                                                <button onClick={() => moureElement(pos, 1)} disabled={pos === ordreUsuari.length - 1} className="w-12 h-12 rounded-lg bg-white/20 hover:bg-white/30 disabled:opacity-30 text-white font-bold text-xl active:scale-90">â–¼</button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            {!mostrarResultat && <button onClick={() => handleResposta('order')} className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95">{t("CONFIRMAR", "CONFIRMAR", "CONFIRM")}</button>}
                        </div>
                    )}
                    
                    {/* BotÃ³ segÃ¼ent */}
                    {mostrarResultat && (
                        <div className="mt-6 pt-6 border-t border-white/20">
                            <button onClick={seguentPregunta} className="w-full py-5 gold-gradient text-slate-900 font-black text-lg rounded-xl hover:opacity-90 transform hover:scale-[1.02] transition-all active:scale-95">
                                {preguntaActual + 1 >= preguntesPartida.length ? `ğŸ† ${t('RESULTATS', 'RESULTADOS', 'RESULTS')}` : `${t('SEGÃœENT', 'SIGUIENTE', 'NEXT')} â†’`}
                            </button>
                        </div>
                    )}
                </Card>
            </div>
        );
    };

    // PANTALLA RESULTATS
    const PantallaResultats = () => {
        const correctes = respostes.filter(r => r.correcta).length;
        const pct = ((correctes / respostes.length) * 100).toFixed(0);
        const tempsTotal = respostes.reduce((acc, r) => acc + r.temps, 0);
        const mitjana = (tempsTotal / respostes.length).toFixed(1);
        const posRanking = ranking.findIndex(r => r.nom === nomJugador && r.punts === puntuacio) + 1;
        
        let emoji, msg, color;
        if (pct >= 90) { emoji = 'ğŸ†'; msg = t('EXCELÂ·LENT!', 'Â¡EXCELENTE!', 'EXCELLENT!'); color = 'from-yellow-400 to-amber-500'; }
        else if (pct >= 70) { emoji = 'ğŸ‰'; msg = t('MOLT BÃ‰!', 'Â¡MUY BIEN!', 'VERY GOOD!'); color = 'from-green-400 to-emerald-500'; }
        else if (pct >= 50) { emoji = 'ğŸ‘'; msg = t('BÃ‰!', 'Â¡BIEN!', 'GOOD!'); color = 'from-blue-400 to-cyan-500'; }
        else { emoji = 'ğŸ’ª'; msg = t('CONTINUA!', 'Â¡SIGUE!', 'KEEP GOING!'); color = 'from-purple-400 to-pink-500'; }
        
        return (
            <div className="max-w-2xl mx-auto space-y-6 animate-fade">
                <Confetti show={showConfetti} />
                
                <div className={`text-center py-10 bg-gradient-to-r ${color} rounded-3xl relative overflow-hidden`}>
                    <div className="absolute inset-0 bg-white/10"></div>
                    <span className="text-8xl block mb-4 animate-bounce relative z-10">{emoji}</span>
                    <h2 className="text-4xl font-black text-white mb-2 relative z-10">{msg}</h2>
                    <p className="text-xl text-white/80 relative z-10">{nomJugador}</p>
                </div>
                
                <Card>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div className="p-4 bg-yellow-400/20 rounded-xl">
                            <p className="text-4xl font-black text-yellow-400">{puntuacio}</p>
                            <p className="text-sm text-purple-300">{t("Punts", "Puntos", "Points")}</p>
                        </div>
                        <div className="p-4 bg-green-400/20 rounded-xl">
                            <p className="text-4xl font-black text-green-400">{correctes}/{respostes.length}</p>
                            <p className="text-sm text-purple-300">{t("Encerts", "Aciertos", "Correct")}</p>
                        </div>
                        <div className="p-4 bg-blue-400/20 rounded-xl">
                            <p className="text-4xl font-black text-blue-400">{pct}%</p>
                            <p className="text-sm text-purple-300">{t("PrecisiÃ³", "PrecisiÃ³n", "Accuracy")}</p>
                        </div>
                        <div className="p-4 bg-orange-400/20 rounded-xl">
                            <p className="text-4xl font-black text-orange-400">ğŸ”¥{maxRatxa}</p>
                            <p className="text-sm text-purple-300">{t("Max ratxa", "Max racha", "Max streak")}</p>
                        </div>
                    </div>
                    
                    {posRanking > 0 && posRanking <= 10 && (
                        <div className="mt-6 p-5 gold-gradient rounded-xl text-center animate-glow">
                            <span className="text-4xl">ğŸ†</span>
                            <p className="font-black text-2xl text-slate-900">{t(`TOP ${posRanking}!`, `Â¡TOP ${posRanking}!`, `TOP ${posRanking}!`)}</p>
                        </div>
                    )}
                </Card>
                
                <div className="flex gap-3">
                    <button onClick={() => { setFase('inici'); setPuntuacio(0); setRespostes([]); setMaxRatxa(0); }} className="flex-1 py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl hover:opacity-90 active:scale-95 transition-all">
                        ğŸ”„ {t("Tornar a jugar", "Volver a jugar", "Play again")}
                    </button>
                    <button onClick={() => setFase('ranking')} className="flex-1 py-4 gold-gradient text-slate-900 font-bold rounded-xl hover:opacity-90 active:scale-95 transition-all">
                        ğŸ† Ranking
                    </button>
                </div>
            </div>
        );
    };

    // PANTALLA RANKING
    const PantallaRanking = () => (
        <div className="max-w-2xl mx-auto space-y-6 animate-fade">
            <div className="text-center py-8">
                <span className="text-6xl mb-4 block animate-bounce">ğŸ†</span>
                <h2 className="text-4xl font-black text-white">TOP 10</h2>
                <p className="text-purple-300">{t("Els millors jugadors", "Los mejores jugadores", "Top players")}</p>
            </div>
            
            <Card>
                {ranking.length === 0 ? (
                    <div className="text-center py-10 text-purple-300">
                        <span className="text-5xl block mb-3">ğŸ“­</span>
                        <p className="text-lg">{t("Encara no hi ha puntuacions", "AÃºn no hay puntuaciones", "No scores yet")}</p>
                        <p className="text-sm mt-1">{t("Sigues el primer!", "Â¡SÃ© el primero!", "Be the first!")}</p>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {ranking.map((entry, i) => (
                            <div key={i} className={`flex items-center gap-4 p-4 rounded-xl transition-all hover:scale-[1.02] ${i === 0 ? 'gold-gradient animate-glow' : i === 1 ? 'bg-slate-300/20' : i === 2 ? 'bg-orange-400/20' : 'bg-white/5'}`}>
                                <div className={`w-12 h-12 rounded-full flex items-center justify-center font-black text-xl ${i === 0 ? 'bg-yellow-600 text-yellow-100' : i === 1 ? 'bg-slate-400 text-slate-100' : i === 2 ? 'bg-orange-600 text-orange-100' : 'bg-white/20 text-white'}`}>
                                    {i === 0 ? 'ğŸ‘‘' : i + 1}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className={`font-bold text-lg truncate ${i === 0 ? 'text-slate-900' : 'text-white'}`}>{entry.nom}</p>
                                    <p className={`text-xs truncate ${i === 0 ? 'text-slate-700' : 'text-purple-300'}`}>
                                        {entry.data} Â· {entry.correctes}/20 Â· ğŸ”¥{entry.maxRatxa || 0}
                                    </p>
                                </div>
                                <div className="text-right">
                                    <p className={`text-2xl font-black ${i === 0 ? 'text-slate-900' : 'text-yellow-400'}`}>{entry.punts}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </Card>
            
            <button onClick={() => setFase('inici')} className="w-full py-4 bg-white/10 border border-white/30 text-white font-bold rounded-xl hover:bg-white/20 active:scale-95 transition-all">
                â† {t("Tornar", "Volver", "Back")}
            </button>
        </div>
    );

    return (
        <div className="min-h-screen py-6 px-4">
            <Toast {...toast} />
            <PointsPopup {...pointsPopup} />
            <div className="max-w-4xl mx-auto">
                {fase === 'inici' && <PantallaInici />}
                {fase === 'jugant' && <PantallaJoc />}
                {fase === 'resultats' && <PantallaResultats />}
                {fase === 'ranking' && <PantallaRanking />}
                <footer className="mt-8 text-center text-purple-400/60 text-sm">
                    <p>Concurs PDE Â· profedeeconomia.es Â· 2025</p>
                </footer>
            </div>
        </div>
    );
}

ReactDOM.render(<ConcursApp />, document.getElementById('root'));
    </script>
</body>
</html>
